<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Page</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #fff7f0;
      padding: 50px;
    }
    h1 {
      color: #444;
    }
    .btn {
      display: inline-block;
      margin: 10px;
      padding: 12px 24px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      transition: background 0.3s;
    }
    .btn:hover {
      background: #1e7e34;
    }

  </style>
</head>
<body>
  <h1>Welcome Back to Home</h1>
  <!-- Link back to Index -->
  <a href="Expense.html" class="btn">Expense Page</a>
<a href="FBR.html" class="btn">Tax Invoices</a>
</body>
</html>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NUTRION Invoice & Ledger V7.18</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #eef2f7;
            color: #333;
        }
        h2 {
            text-align: center;
            background-color: #FFA500;
            color: white;
            padding: 18px 15px;
            margin-top: 0;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .section-container {
            background-color: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #ddd;
        }
        .section-container h3 {
            margin-top: 0;
            color: #FFA500;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ced4da;
            border-radius: 5px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        #ledgerDisplayArea, #stockDisplayArea, #paymentDisplayArea, #openingBalanceHistoryArea {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            min-height: 100px;
            max-height: 550px;
            overflow-y: auto;
        }
        #ledgerDisplayArea p, #stockDisplayArea p, #paymentDisplayArea p, #openingBalanceHistoryArea p {
            margin: 10px 0;
            line-height: 1.7;
        }
        #ledgerDisplayArea h4, #paymentDisplayArea h4, #openingBalanceHistoryArea h4 {
            color: #17572a;
            margin-top: 15px;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }
        #ledgerDisplayArea strong, #paymentDisplayArea strong, #openingBalanceHistoryArea strong {
            color: #333;
        }
        .ledger-closing-balance {
            font-weight: bold;
            color: #FFA500;
            font-size: 1.15em;
            padding: 10px 15px;
            background-color: #e6ffed;
            border-radius: 6px;
            display: block;
            text-align: right;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            text-align: left;
            font-size: 0.95em;
        }
        th {
            background-color: #e9f5ee;
            color: #206a3a;
            font-weight: 600;
            text-align: center;
        }
        td.text-right, th.text-right { text-align: right; }
        td.text-center, th.text-center { text-align: center; }
        .no-entries {
            color: #777;
            font-style: italic;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            text-align: center;
        }
        table#invoiceTable, table#stockEntryTable, table#paymentDisplayTable, table#openingBalanceHistoryTable {
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        table#invoiceTable td, table#invoiceTable th, table#stockEntryTable td, table#stockEntryTable th, table#paymentDisplayTable td, table#paymentDisplayTable th, table#openingBalanceHistoryTable td, table#openingBalanceHistoryTable th {
            border: 1px solid #dee2e6;
            padding: 12px 15px;
            text-align: center;
            font-size: 14px;
        }
        table#invoiceTable th, table#stockEntryTable th, table#paymentDisplayTable th, table#openingBalanceHistoryTable th {
            background-color: #f0f9ff;
            font-weight: 600;
            color: #343a40;
        }
        #invoiceTable thead tr.party-details-header td {
            background-color: #e6f4ea;
            border: none;
        }
        .highlight {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .green-highlight {
            background-color: #e6ffed;
            font-weight: bold;
        }
        .green-highlight input[type="number"] {
            font-weight: bold;
        }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        input.conditionally-readonly:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        input.editable {
            background-color: #fff !important;
            cursor: text !important;
        }
        .btn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
            padding-bottom: 20px;
            gap: 10px;
        }
        .btn {
            padding: 12px 22px;
            background-color: #FFA500;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .invoice-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .invoice-type {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .invoice-details {
            text-align: right;
        }

        .invoice-details div {
            margin-bottom: 5px;
        }

        .bill-to {
            margin-bottom: 20px;
        }

        .bill-to h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .products-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        .products-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .products-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .totals-section {
            margin-left: auto;
            width: 50%;
            margin-bottom: 25px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .grand-total {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
            border-top: 2px solid #2c3e50;
            padding-top: 10px;
        }

        .amount-in-words {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #2c3e50;
        }

        .notes {
            margin-bottom: 25px;
            font-size: 14px;
            color: #666;
        }

        .address {
            text-align: center;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4a6491, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .product-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .product-row input {
            flex: 1;
        }

        .add-product {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px dashed #2c3e50;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-product:hover {
            background: #e9ecef;
        }

        .remove-product {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .totals-section {
                width: 100%;
            }
        }
        {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            background-color: #f9f9f9;
        }
        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .company-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }
        .company-address {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .company-email {
            font-size: 14px;
            color: #555;
        }
        .invoice-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 20px 0;
        }
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .invoice-details div {
            flex: 1;
        }
        .bill-to {
            margin-bottom: 20px;
        }
        .bill-to h3 {
            margin-bottom: 5px;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .text-right {
            text-align: right;
        }
        .total-section {
            margin-top: 20px;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .total-label {
            font-weight: bold;
        }
        .notes {
            margin-top: 30px;
            font-size: 14px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
        }
        .footer {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
        }
        .signature {
            text-align: center;
            border-top: 1px solid #333;
            padding-top: 5px;
            width: 200px;
        }
        .gst-field {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .gst-field input {
            width: 60px;
            padding: 5px;
        }
        .btn {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 20px;
        }{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f7f9;
      color: #333;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .invoice-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #eee;
    }

    .company-name {
      font-size: 28px;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 5px;
    }

    .company-address {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }

    .invoice-type {
      font-size: 22px;
      font-weight: bold;
      color: #2c3e50;
      margin: 15px 0;
    }

    .invoice-details {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .invoice-details div {
      margin-bottom: 8px;
    }

    .bill-to {
      margin-bottom: 20px;
    }

    .bill-to h3 {
      margin-bottom: 10px;
      color: #2c3e50;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px 15px;
      text-align: left;
    }

    th {
      background-color: #f0f9ff;
      font-weight: 600;
      color: #343a40;
    }

    .totals-section {
      margin-left: auto;
      width: 50%;
      margin-bottom: 25px;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .grand-total {
      font-weight: bold;
      font-size: 18px;
      color: #2c3e50;
      border-top: 2px solid #2c3e50;
      padding-top: 10px;
    }

    .amount-in-words {
      margin-bottom: 25px;
      padding: 15px;
      background-color: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #2c3e50;
    }

    .notes {
      margin-bottom: 25px;
      font-size: 14px;
      color: #666;
    }

    .signature-area {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
    }

    .signature-box {
      width: 200px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #444;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .form-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .btn {
      padding: 12px 25px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn:hover {
      background: #4a6491;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .product-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .product-row input {
      flex: 1;
    }

    .add-product {
      background: #f8f9fa;
      color: #2c3e50;
      border: 1px dashed #2c3e50;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .add-product:hover {
      background: #e9ecef;
    }

    .remove-product {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 0;
      }

      .totals-section {
        width: 100%;
      }
    }
    * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7f9;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 18px;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .invoice-preview {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .invoice-type {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .invoice-details {
            text-align: right;
        }

        .invoice-details div {
            margin-bottom: 5px;
        }

        .bill-to {
            margin-bottom: 20px;
        }

        .bill-to h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .products-table th {
            background-color: #2c3e50;
            color: white;
            padding: 12px 15px;
            text-align: left;
        }

        .products-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .products-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .totals-section {
            margin-left: auto;
            width: 50%;
            margin-bottom: 25px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .grand-total {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
            border-top: 2px solid #2c3e50;
            padding-top: 10px;
        }

        .amount-in-words {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #2c3e50;
        }

        .notes {
            margin-bottom: 25px;
            font-size: 14px;
            color: #666;
        }

        .address {
            text-align: center;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 5px;
            margin-bottom: 30px;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .form-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4a6491, #2c3e50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .product-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .product-row input {
            flex: 1;
        }

        .add-product {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px dashed #2c3e50;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-product:hover {
            background: #e9ecef;
        }

        .remove-product {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
        }

        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .totals-section {
                width: 100%;
            }
        }
        .btn:hover {
            background-color: #45a049;
        }
        .btn.btn-info { background-color: #007bff; }
        .btn.btn-info:hover { background-color: #0056b3; }
        .btn.btn-warning { background-color: #ffc107; color: #212529; }
        .btn.btn-warning:hover { background-color: #e0a800; }
        .btn.btn-secondary { background-color: #6c757d; }
        .btn.btn-secondary:hover { background-color: #545b62; }
        .btn.btn-success-outline { background-color: #fff; color: #FFA500; border: 1px solid #FFA500; }
        .btn.btn-success-outline:hover { background-color: #FFA500; color: #fff; }
        .btn.btn-danger { background-color: #dc3545; }
        .btn.btn-danger:hover { background-color: #c82333; }
        .btn.btn-success { background-color: #FFA500; }
        .btn.btn-success:hover { background-color: #218838; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn:hover:not(:disabled) { background-color: #218838; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:active:not(:disabled) { transform: translateY(0px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bold { font-weight: bold; font-size: 16px; }
        #invoiceTable .party-details td { border: none; padding: 15px 10px; }
        #invoiceTable .party-details input,
        #invoiceTable .party-details select { border: 1px solid #ced4da; }
        #invoiceTable tfoot td { text-align: right; padding-right: 30px; }
        #invoiceTable tfoot td:last-child { text-align: center; }
        #invoiceTable tfoot input[type="number"] { text-align: center; }
        .flex-inputs { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; }
        .flex-inputs > div { flex-grow: 1; min-width: 150px; }
        .flex-inputs button, .flex-inputs .btn { flex-shrink: 0; height: 42px; margin-bottom: 15px; }
        #persistenceStatus { text-align: center; font-size: 0.9em; color: #666; margin-bottom: 15px; padding: 8px; background-color: #f0f0f0; border-radius: 4px; border: 1px solid #e0e0e0; display: block; word-wrap: break-word; }
        .item-entry-row input[type="number"],
        .item-entry-row input[type="text"],
        .item-entry-row select { text-align: center; }
        .item-entry-row .amount { font-weight: 500; }
        #editInvoiceSection .input-group { max-width: 300px; }
        .remove-row-btn, .action-btn { background-color: #ff6b6b; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; margin: 0 2px; }
        .remove-row-btn:hover, .action-btn:hover { opacity: 0.10; }
        .action-btn.edit { background-color: #54a0ff;}
        .action-btn.delete { background-color: #ff6b6b;}

        .new-ledger-table, .payment-list-table, .opening-balance-history-table {
            border: 1px solid #b0b0b0;
            margin-bottom: 20px;
        }
        .new-ledger-table th, .payment-list-table th, .opening-balance-history-table th {
            background-color:#FFA500;
            color: white;
            padding: 12px;
        }
        .new-ledger-table td, .payment-list-table td, .opening-balance-history-table td {
            padding: 10px;
            vertical-align: middle;
            border-color: #e0e0e0;
        }
        .new-ledger-table tbody tr:nth-child(even), .payment-list-table tbody tr:nth-child(even), .opening-balance-history-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .new-ledger-table .opening-balance-row td {
            font-weight: bold;
            background-color: #e9ecef;
            padding: 12px 10px;
        }
        .new-ledger-table .payment-row td {
            font-weight: bold;
            color: #b33e00;
            background-color: #fff4e6;
            padding: 12px 10px;
        }
        .new-ledger-table .total-row td {
            font-weight: bold;
            font-size: 1.1em;
            background-color: #e6ffed;
            color: #155724;
            border-top: 2px solid #FFA500;
            padding: 12px 10px;
        }
        .new-ledger-table .product-name-col {
            padding-left: 25px;
        }
        .remarks-based-section, .party-exclude-section {
    background-color: #fff;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid #ddd;
}

.remarks-based-section h3, .party-exclude-section h3 {
    margin-top: 0;
    color: #FFA500;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}
    </style>
</head>
<body>
    <h2>NUTRION - Invoice, Ledger & Stock</h2>
    <div id="persistenceStatus">Initializing application...</div>
    <div class="section-container payment-section">
        <h3>Payment Recieved </h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="paymentPartyName">Party Name:</label>
                <input type="text" id="paymentPartyName" list="partyListForPayment" placeholder="Select or type party name">
                <datalist id="partyListForPayment"></datalist>
            </div>
            <div class="input-group">
                <label for="paymentAmount">Amount Received:</label>
                <input type="number" id="paymentAmount" placeholder="0.00" min="0" step="0.01">
            </div>
            <div class="input-group">
                <label for="paymentRemarks">Remarks (Wajah):</label>
                <input type="text" id="paymentRemarks" placeholder="e.g., Advance, Bill Clearance">
            </div>
            <div class="input-group">
                <label for="paymentDate">Payment Date:</label>
                <input type="date" id="paymentDate">
            </div>
            <button class="btn" onclick="recordPayment()">Save Payment</button>
            <button class="btn btn-info" id="downloadPaymentReceiptBtn" onclick="downloadLastPaymentReceiptPDF()" style="display: none;">Download Payment Receipt PDF</button>
        </div>
    </div>

    <div class="section-container payment-range-section">
        <h3>Payments Range Download</h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="paymentStartDate">Start Date:</label>
                <input type="date" id="paymentStartDate">
            </div>
            <div class="input-group">
                <label for="paymentEndDate">End Date:</label>
                <input type="date" id="paymentEndDate">
            </div>
            <button class="btn btn-info" onclick="downloadPaymentsByDateRange()">Download Payments PDF</button>
        </div>
    </div>
    <div class="section-container delete-payment-section">
    <h3>Payment Delete </h3>
    <div class="flex-inputs">
        <div class="input-group">
            <label for="partySearchInputForPayments">Party Name:</label>
            <input type="text" id="partySearchInputForPayments" list="partyListForSearchPayments" placeholder="Enter Party Name to View Payments">
            <datalist id="partyListForSearchPayments"></datalist>
        </div>
        <button class="btn btn-danger" onclick="displayPartyPaymentsForDeletion()">Payments See</button>
        <!-- Add this download button -->
        <button class="btn btn-info" onclick="downloadPartyPaymentsPDF()">Download Payments PDF</button>
    </div>
    <div id="paymentDisplayArea">
        <p>Enter Party Name 'Payments See' click on this button and see the payments details.</p>
    </div>
</div>

    <div class="section-container invoice-range-section">
        <h3>Invoices Range Download</h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="invoiceStartDate">Start Date:</label>
                <input type="date" id="invoiceStartDate">
            </div>
            <div class="input-group">
                <label for="invoiceEndDate">End Date:</label>
                <input type="date" id="invoiceEndDate">
            </div>
            <button class="btn btn-danger" onclick="downloadInvoicesByDateRange()">Download Invoices PDF</button>
        </div>
    </div>
<!-- New Section: Remarks-based (only rows with "Bilty Expense") -->
<div class="section-container remarks-based-section">
    <h3>Bilty Expense Report</h3>
    <div class="flex-inputs">
        <div class="input-group">
            <label for="biltyStartDate">Start Date:</label>
            <input type="date" id="biltyStartDate">
        </div>
        <div class="input-group">
            <label for="biltyEndDate">End Date:</label>
            <input type="date" id="biltyEndDate">
        </div>
        <button class="btn btn-info" onclick="generateBiltyExpensePDF()">Download Bilty Expense Report PDF</button>
    </div>
</div>

<!-- New Section: Party-based (exclude selected party) -->
<div class="section-container party-exclude-section">
    <h3>Party Exclude Report</h3>
    <div class="flex-inputs">
        <div class="input-group">
            <label for="excludePartyName">Parties to Exclude:</label>
            <select id="excludePartyName" multiple size="4" style="height: auto; min-height: 38px; width: 100%;">
                <option value="">Select parties to exclude</option>
            </select>
            <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                Hold Ctrl/Cmd to select multiple parties • Use Shift for range selection
            </small>
        </div>
        <div class="input-group">
            <label for="excludeStartDate">Start Date:</label>
            <input type="date" id="excludeStartDate">
        </div>
        <div class="input-group">
            <label for="excludeEndDate">End Date:</label>
            <input type="date" id="excludeEndDate">
        </div>
        <button class="btn btn-warning" onclick="generatePartyExcludePDF()">Download Party Exclude Report PDF</button>
    </div>

    <!-- Selected Parties Summary -->
    <div id="selectedPartiesSummary" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
        <strong>Selected for exclusion:</strong>
        <span id="selectedPartiesList" style="color: #d63384; margin-left: 5px;"></span>
        <span id="selectedPartiesCount" style="color: #0d6efd; margin-left: 10px;"></span>
    </div>
</div>
    <div class="section-container no-bilty-section">
    <h3>Payments Without Bilty Expense</h3>
    <div class="flex-inputs">
        <div class="input-group">
            <label for="noBiltyStartDate">Start Date:</label>
            <input type="date" id="noBiltyStartDate">
        </div>
        <div class="input-group">
            <label for="noBiltyEndDate">End Date:</label>
            <input type="date" id="noBiltyEndDate">
        </div>
        <div class="input-group">
            <button class="btn btn-success" onclick="generateNoBiltyExpensePDF()">Download Payments Without Bilty PDF</button>
        </div>
    </div>
</div>
    <div class="section-container ledger-section">
        <h3>Feed Mills Ledger Details</h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="partySearchInput">Party Name:</label>
                <input type="text" id="partySearchInput" list="partyListForSearch" placeholder="Enter Party Name to Search Ledger">
                <datalist id="partyListForSearch"></datalist>
            </div>
            <button class="btn" onclick="displayPartyLedger()">Ledger See</button>
            <button class="btn btn-success-outline" id="downloadLedgerPdfBtn" onclick="downloadLedgerPDF()" style="display: none;">Party Ledger PDF </button>
        </div>
        <div id="ledgerDisplayArea">
            <p>Enter Party Name 'Ledger See' Click on this and See Ledger Details.</p>
        </div>
    </div>
    <div class="section-container opening-balance-history-section">
        <h3>Opening Balance History</h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="partySearchInputForHistory">Party Name:</label>
                <input type="text" id="partySearchInputForHistory" list="partyListForSearchHistory" placeholder="Enter Party Name to View History">
                <datalist id="partyListForSearchHistory"></datalist>
            </div>
            <button class="btn btn-info" onclick="displayOpeningBalanceHistory()">History Check</button>
        </div>
        <div id="openingBalanceHistoryArea">
            <p>Enter Party Name 'History See' Click on this and See  Details.</p>
        </div>
           </div>
    <div class="section-container product-sales-range-section">
  <h3>Product Sales Summary with Date Range</h3>
  <div class="flex-inputs">
    <div class="input-group">
      <label for="productSalesStartDate">Start Date:</label>
      <input type="date" id="productSalesStartDate">
    </div>
    <div class="input-group">
      <label for="productSalesEndDate">End Date:</label>
      <input type="date" id="productSalesEndDate">
    </div>
    <button class="btn btn-info" onclick="generateProductSalesSummaryPDFWithDateRange()">Product Sales Summary PDF</button>
  </div>
</div>
    <div class="section-container party-invoices-section">
        <h3>Individual Invoices </h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="partyInvoicesPartyName">Party Name:</label>
                <input type="text" id="partyInvoicesPartyName" list="partyListForInvoices" placeholder="Select or type party name">
                <datalist id="partyListForInvoices"></datalist>
            </div>
            <div class="input-group">
                <label for="partyInvoicesStartDate">Start Date:</label>
                <input type="date" id="partyInvoicesStartDate">
            </div>
            <div class="input-group">
                <label for="partyInvoicesEndDate">End Date:</label>
                <input type="date" id="partyInvoicesEndDate">
            </div>
            <button class="btn btn-info" onclick="downloadPartyInvoices()">Party Invoices Download </button>
        </div>
        <div id="partyInvoicesStatus"></div>
    </div>

    <div class="section-container stock-section">
        <h3>Stock Management (Multiple Items)</h3>
        <table id="stockEntryTable">
            <thead>
                <tr>
                    <th>Sr.</th>
                    <th>Product Name</th>
                    <th>Batch No.</th>
                    <th>Date</th>
                    <th>Quantity (In)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="stockEntryRows">
            </tbody>
        </table>
        <div style="text-align: left; margin-top: 10px; margin-bottom: 20px; padding-left: 5px;">
            <button type="button" class="btn btn-success-outline" style="padding: 8px 15px; font-size: 14px;" onclick="addNewStockRow()">+ Add Stock Item</button>
        </div>
        <div class="btn-container" style="justify-content: flex-start;">
            <button class="btn btn-success" onclick="saveAllStock()">Save All Added Stock</button>
        </div>
        <hr style="margin: 25px 0;">
        <h3>Available Stock</h3>
        <div id="stockDisplayArea">
            <table id="stockDisplayTable">
                <thead>
                    <tr>
                        <th>Sr.</th>
                        <th>Product Name</th>
                        <th>Batch No.</th>
                        <th>Date Added</th>
                        <th>Available Stock</th>
                    </tr>
                </thead>
                <tbody id="stockTableBody">
                </tbody>
            </table>
        </div>
        <div class="btn-container" style="justify-content: flex-start; padding-top: 10px;">
            <button class="btn btn-info" onclick="downloadStockReportPDF()">Stock Report PDF</button>
        </div>
    </div>

    <div class="section-container" id="editInvoiceSection">
        <h3>Invoice Update&Delete Karen</h3>
        <div class="flex-inputs">
            <div class="input-group">
                <label for="searchInvoiceNumberInput">Invoice Number Likhen:</label>
                <input type="text" id="searchInvoiceNumberInput" placeholder="Enter Invoice # to Edit/Delete">
            </div>
            <button class="btn btn-info" onclick="searchInvoiceToEdit()">Search Aur Load Invoice</button>
            <button class="btn btn-danger" id="deleteInvoiceBtn" onclick="deleteLoadedInvoice()" style="display: none;">Delete Loaded Invoice</button>
        </div>
    </div>
    <table id="invoiceTable">
        <thead>
            <tr class="party-details-header">
                <td colspan="7" style="text-align:left; padding-left:10px; font-size: 1.2em; color: #FFA500;" id="invoiceFormTitle">Create New Invoice</td>
            </tr>
            <tr class="party-details">
                <td colspan="3">
                    <label for="party" class="bold">Party Name:</label>
                    <input type="text" id="party" list="partyListForInvoice" onchange="handlePartyChange()">
                    <datalist id="partyListForInvoice"></datalist>
                </td>
                <td>
                    <label for="date" class="bold">Date:</label>
                    <input type="date" id="date">
                </td>
                <td colspan="2">
                    <label for="invoice" class="bold">Invoice #:</label>
                    <input type="text" id="invoice" class="conditionally-readonly" readonly style="width: 120px;">
                </td>
                <td></td>
            </tr>
            <tr>
                <th>Sr</th>
                <th>Product Name</th>
                <th>Qty</th>
                <th>Packing</th>
                <th>Unit Price</th>
                <th>Amount</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot>
            <tr class="highlight">
                <td colspan="5">Subtotal</td>
                <td id="totalAmountCell"><span id="totalAmount">0.00</span></td>
                <td></td>
            </tr>
            <tr class="green-highlight">
                <td colspan="4">GST</td>
                <td><input type="number" id="gstPercentage" value="00" min="0" max="100" style="width: 50px;" onchange="updateGSTAmount()">%</td>
                <td id="gstAmountCell"><span id="gstAmount">0.00</span></td>
                <td></td>
            </tr>
            <tr class="green-highlight">
                <td colspan="4">Previous Balance</td>
                <td><button type="button" class="btn btn-secondary btn-sm" id="editPrevBalanceBtn" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" onclick="togglePrevBalanceEdit()">Edit</button></td>
                <td><input type="number" id="prevBalance" value="0.00" readonly></td>
                <td></td>
            </tr>
            <tr class="green-highlight">
                <td colspan="5">Grand Total</td>
                <td id="grandTotalCell"><span id="grandTotal">0.00</span></td>
                <td></td>
            </tr>
        </tfoot>
    </table>
    <div style="text-align: left; margin-top: 10px; margin-bottom: 20px; padding-left: 5px;">
        <button type="button" class="btn btn-success-outline" style="padding: 8px 15px; font-size: 14px;" onclick="addNewInvoiceItemRow()">+ Add Product</button>
    </div>
    <div class="btn-container">
        <button class="btn" id="saveOrUpdateInvoiceBtn" onclick="saveInvoice()">Save Invoice</button>
        <button class="btn btn-danger" onclick="downloadCurrentInvoicePDF()">Current Invoice PDF </button>
        <button class="btn btn-success" onclick="downloadAllPartyLedgersPDF()">All Party Balances PDF</button>
        <button class="btn btn-info" id="productSalesSummaryBtn" onclick="generateProductSalesSummaryPDF()">Sales Summary with Party Details PDF</button>
        <button class="btn btn-warning" onclick="resetInvoiceForm()">Clear Invoice Form</button>
        <button class="btn btn-info" onclick="window.location.reload()">Refresh Page</button>
        <div class="section-container file-load-area" style="width:100%; margin-top: 15px; padding: 15px;">
            <!--
<h3 style="margin-bottom:10px;">Data Management</h3>
<button class="btn btn-danger" onclick="deleteAllBackendData()">Delete All Backend Data</button>
<p style="font-size: 0.9em; color: #666; margin-top: 10px;">
    <strong>DANGER: Yeh server se tamam data (invoices, payments, party balances) DELETE kar dega.</strong>
    Yeh action reverse nahi kiya ja sakta.
</p>
-->
        </div>
    </div>

    <script>
         const { jsPDF } = window.jspdf;
        const API_BASE_URL = 'http://127.0.0.1:5000';
        const MAX_INVOICE_ITEMS_CAP = 15;
const initialProductOptions = [
  "Strophase G",
  "Strophase P",
  "Strozyme NSP",
  "SP200",
  "SP300",
  "SP300 Advance",
  "Monica",
  "Linco Magic",
  "Enra Magic",
  "InduceAcid Plus",
  "InduceAcid Buty",
  "Huntox",
  "Strozyme XYL",
  "Super Ener Emusifier",
  "Antioxdant",
  "Toxin Binder Weilituo",
  "Toxin Clean",
  "GutPro 60 (Tributyrin)",
  "InduceAcid Liquid"
];

const productPackingMap = {
  "Strophase G": "Kg",
  "Strophase P": "Kg",
  "Strozyme NSP": "Kg",
  "SP200": "Kg",
  "SP300": "Kg",
  "SP300 Advance": "Kg",
  "Monica": "Kg",
  "Linco Magic": "Kg",
  "Enra Magic": "Kg",
  "InduceAcid Plus": "Kg",
  "InduceAcid Buty": "Kg",
  "Huntox": "Kg",
  "Strozyme XYL": "Kg",
  "Super Ener Emusifier": "Kg",
  "Antioxdant": "Kg",
  "Toxin Binder Weilituo": "Kg",
  "Toxin Clean": "Kg",
  "GutPro 60 (Tributyrin)": "Kg",
  "InduceAcid Liquid": "Ltr" // only this stays in Ltr
};

const packingOptions = ["Ltr", "Kg", "25 Ltr"];

        const COMPANY_NAME = "NUTRION";
        const NUTRION_ADDRESS = "  Address: Pearl City Sargodha Road Faisalabad ";
        const NUTRION_CONTACT = "                   Contact: +923007993003";
        const PDF_PRIMARY_COLOR = [40, 167, 69];
        const PDF_SECONDARY_COLOR = [0, 123, 255];
        const PDF_TERTIARY_COLOR = [240, 173, 78];
        const PDF_TEXT_COLOR = [50, 50, 50];
        const PDF_MUTED_TEXT_COLOR = [100, 100, 100];
        const PDF_TABLE_ALT_ROW_BG = [248, 252, 249];
        const rowsContainer = document.getElementById('rows');
        const partyInput = document.getElementById('party');
        const partyListForInvoiceDatalist = document.getElementById('partyListForInvoice');
        const partyListForPaymentDatalist = document.getElementById('partyListForPayment');
        const partyListForSearchDatalist = document.getElementById('partyListForSearch');
        const partyListForSearchPaymentsDatalist = document.getElementById('partyListForSearchPayments');
        const partyListForSearchHistoryDatalist = document.getElementById('partyListForSearchHistory');
        const prevBalanceInput = document.getElementById('prevBalance');
        const editPrevBalanceBtn = document.getElementById('editPrevBalanceBtn');
        const dateInput = document.getElementById('date');
        const invoiceNumberInput = document.getElementById('invoice');
        const totalAmountSpan = document.getElementById('totalAmount');
        const grandTotalSpan = document.getElementById('grandTotal');
        const gstPercentageInput = document.getElementById('gstPercentage');
        const gstAmountSpan = document.getElementById('gstAmount');
        const partySearchInput = document.getElementById('partySearchInput');
        const partySearchInputForPayments = document.getElementById('partySearchInputForPayments');
        const partySearchInputForHistory = document.getElementById('partySearchInputForHistory');
        const ledgerDisplayArea = document.getElementById('ledgerDisplayArea');
        const paymentDisplayArea = document.getElementById('paymentDisplayArea');
        const openingBalanceHistoryArea = document.getElementById('openingBalanceHistoryArea');
        const paymentPartyNameInput = document.getElementById('paymentPartyName');
        const paymentAmountInput = document.getElementById('paymentAmount');
        const paymentDateInput = document.getElementById('paymentDate');
        const paymentRemarksInput = document.getElementById('paymentRemarks');
        const persistenceStatusDiv = document.getElementById('persistenceStatus');
        const downloadLedgerPdfBtn = document.getElementById('downloadLedgerPdfBtn');
        const downloadPaymentReceiptBtn = document.getElementById('downloadPaymentReceiptBtn');
        const searchInvoiceNumberInputEl = document.getElementById('searchInvoiceNumberInput');
        const invoiceFormTitle = document.getElementById('invoiceFormTitle');
        const saveOrUpdateInvoiceBtn = document.getElementById('saveOrUpdateInvoiceBtn');
        const deleteInvoiceBtn = document.getElementById('deleteInvoiceBtn');
        const paymentStartDateInput = document.getElementById('paymentStartDate');
        const paymentEndDateInput = document.getElementById('paymentEndDate');
        const invoiceStartDateInput = document.getElementById('invoiceStartDate');
        const invoiceEndDateInput = document.getElementById('invoiceEndDate');
        const stockEntryRowsContainer = document.getElementById('stockEntryRows');
        const stockTableBody = document.getElementById('stockTableBody');
        let currentEditingInvoiceNumber = null;
        let currentLedgerDataForPDF = null;
        let productOptionsCache = [...initialProductOptions];
        let lastPaymentDetails = null;
        let logoBase64 = null;
        let signatureBase64 = null;
        let itemSrNo = 1;
        let stockSrNo = 1;
        let currentPartyInitialBalance = 0.0;
        function showLoadingStatus(message) {
            persistenceStatusDiv.textContent = message;
            persistenceStatusDiv.style.backgroundColor = '#fff3cd';
            persistenceStatusDiv.style.color = '#664d03';
            persistenceStatusDiv.style.border = '1px solid #ffecb5';
            document.querySelectorAll('.btn').forEach(button => button.disabled = true);
        }
        function sortPayments(payments) {
    return payments.sort((a, b) => new Date(a.date) - new Date(b.date));
}

function sortInvoices(invoices) {
    return invoices.sort((a, b) => new Date(a.date) - new Date(b.date));
}

function formatNumberInIndianStyle(number) {
    if (number === null || number === undefined || isNaN(number)) {
        return '0';
    }

    let num = parseFloat(number);
    if (num === 0) {
        return '0';
    }

    let isNegative = num < 0;
    num = Math.abs(num);

    // Split into integer and decimal parts (2 decimals for checking only)
    let parts = num.toFixed(2).split('.');
    let integerPart = parts[0];
    let decimalPart = parts[1];

    // Use international style commas
    integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");

    let formattedNumber = integerPart;

    // Add decimals only if not .00
    if (parseFloat(decimalPart) !== 0) {
        formattedNumber += "." + decimalPart;
    }

    return isNegative ? "-" + formattedNumber : formattedNumber;
}

// Function to apply formatting to all number displays
function applyIndianNumberFormatting() {
    document.querySelectorAll('span, td, .amount, .text-right').forEach(element => {
        const text = element.textContent || element.value;
        if (text && /^\s*[\d,]+\.?\d*\s*$/.test(text.replace(/^-/, ''))) {
            const num = parseFloat(text.replace(/,/g, ''));
            if (!isNaN(num)) {
                if (element.tagName === 'INPUT') {
                    element.value = formatNumberInIndianStyle(num);
                } else {
                    element.textContent = formatNumberInIndianStyle(num);
                }
            }
        }
    });
}
        function hideLoadingStatus(messageOrError, isError = false) {
            let finalMessage = "";
            let actualIsError = isError;
            if (typeof messageOrError === 'string') {
                finalMessage = messageOrError;
            } else if (messageOrError instanceof Error) {
                finalMessage = `Error: ${messageOrError.message}`;
                if (messageOrError.responseMessage) finalMessage += ` (Server: ${messageOrError.responseMessage})`;
                actualIsError = true;
            } else if (typeof messageOrError === 'object' && messageOrError !== null && messageOrError.error) {
                finalMessage = `Error: ${messageOrError.error}`;
                actualIsError = true;
            } else {
                finalMessage = "An unexpected issue occurred.";
                actualIsError = true;
            }
            persistenceStatusDiv.textContent = finalMessage;
            if (actualIsError) {
                persistenceStatusDiv.style.backgroundColor = '#f8d7da';
                persistenceStatusDiv.style.color = '#721c24';
                persistenceStatusDiv.style.border = '1px solid #f5c6cb';
            } else {
                persistenceStatusDiv.style.backgroundColor = '#d1e7dd';
                persistenceStatusDiv.style.color = '#0f5132';
                persistenceStatusDiv.style.border = '1px solid #badbcc';
            }
            setTimeout(() => {
                persistenceStatusDiv.textContent = "Status updates will appear here.";
                persistenceStatusDiv.style.backgroundColor = '#f0f0f0';
                persistenceStatusDiv.style.color = '#666';
                persistenceStatusDiv.style.border = '1px solid #e0e0e0';
            }, actualIsError ? 8000 : 4000);
            document.querySelectorAll('.btn').forEach(button => button.disabled = false);
        }
        // Initialize the new section
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates for party invoices (current month)
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('partyInvoicesStartDate').value = firstDayOfMonth.toISOString().slice(0, 10);
            document.getElementById('partyInvoicesEndDate').value = today.toISOString().slice(0, 10);

            // Populate the party list for the new section
            populatePartyListForInvoices();
        });

        // Function to populate the party list for the invoices section
        async function populatePartyListForInvoices() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/parties`);
                if (!response.ok) await handleFetchError(response, "Filed to Fetch Party List.");
                const parties = await response.json();
                const datalist = document.getElementById('partyListForInvoices');
                datalist.innerHTML = '';

                parties.sort((a, b) => a.name.localeCompare(b.name)).forEach(party => {
                    const option = document.createElement('option');
                    option.value = party.name;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error("Party list load error:", error);
            }
        }

        // Function to download all invoices for a specific party within a date range
        async function downloadPartyInvoices() {
            const partyName = document.getElementById('partyInvoicesPartyName').value.trim();
            const startDate = document.getElementById('partyInvoicesStartDate').value;
            const endDate = document.getElementById('partyInvoicesEndDate').value;
            const statusDiv = document.getElementById('partyInvoicesStatus');

            if (!partyName) {
                statusDiv.innerHTML = '<p style="color: red;">Please Select Party Name.</p>';
                return;
            }

            if (!startDate || !endDate) {
                statusDiv.innerHTML = '<p style="color: red;">Please select start&end date select karen.</p>';
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                statusDiv.innerHTML = '<p style="color: red;">Start date end date select select date before end date.</p>';
                return;
            }

            statusDiv.innerHTML = `<p>${partyName} Invoices are in fectching stage ${startDate} se ${endDate} tak...</p>`;
            try {
                // Fetch invoices for the party within the date range
                // FIXED: Use the correct API endpoint that filters by party name and date range
                const response = await fetch(`${API_BASE_URL}/api/invoices/by-party/${encodeURIComponent(partyName)}?startDate=${startDate}&endDate=${endDate}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        statusDiv.innerHTML = `<p>${partyName} Not find record in specified range.</p>`;
                        return;
                    }
                    await handleFetchError(response, "Invoices fetch Error.");
                }

                const invoices = await response.json();

                if (!invoices || invoices.length === 0) {
                    statusDiv.innerHTML = `<p>${partyName} Not find record in specified range.</p>`;
                    return;
                }

                statusDiv.innerHTML = `<p>${invoices.length} invoices mile hain. PDF banayi ja rahi hai...</p>`;

                // Create a new PDF document
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                let currentPage = 1;
                const totalInvoices = invoices.length;

                // Helper function to add header and footer
                const addHeaderFooter = (doc, pageNum, totalPages) => {
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 12;

                    // Header
                    doc.setFontSize(20);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(40, 167, 69);
                    doc.text(COMPANY_NAME, margin, margin + 5);

                    doc.setFontSize(15);
                    doc.setTextColor(50, 50, 50);
                    const title = `Party Invoices: ${partyName}`;
                    const titleWidth = doc.getTextWidth(title);
                    doc.text(title, pageWidth - margin - titleWidth, margin + 5);

                    doc.setDrawColor(40, 167, 69);
                    doc.setLineWidth(0.6);
                    doc.line(margin, margin + 16, pageWidth - margin, margin + 16);

                    // Footer
                    const footerStartY = doc.internal.pageSize.getHeight() - margin - 18;
                    doc.setDrawColor(40, 167, 69);
                    doc.setLineWidth(0.4);
                    doc.line(margin, footerStartY, pageWidth - margin, footerStartY);

                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth - margin - 20, doc.internal.pageSize.getHeight() - margin + 5);
                };

                // Process each invoice
                for (let i = 0; i < invoices.length; i++) {
                    const invoice = invoices[i];

                    // Add a new page for each invoice (except the first one)
                    if (i > 0) {
                        doc.addPage();
                        currentPage++;
                    }

                    // Add header and footer
                    addHeaderFooter(doc, currentPage, Math.ceil(totalInvoices));

                    let currentY = 48;

                    // Invoice details
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(50, 50, 50);
                    doc.text("Bill To:", 12, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.partyName, 12 + 22, currentY, {maxWidth: doc.internal.pageSize.getWidth() / 2 - 12 - 25});

                    doc.setFont("helvetica", "bold");
                    doc.text("Invoice #:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.invoiceNumber.toString(), doc.internal.pageSize.getWidth() / 2 + 40, currentY);

                    currentY += 7;
                    doc.setFont("helvetica", "bold");
                    doc.text("Date:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.date, doc.internal.pageSize.getWidth() / 2 + 40, currentY);

                    currentY += 12;

                    // Invoice items table
                    const head = [['Sr.', 'Product Name', 'Qty', 'Packing', 'Unit Price', 'Amount']];
                    const body = invoice.items.map((item, index) => [
                        index + 1,
                        item.productName,
                        item.qty,
                        item.packing,
                        item.unitPrice.toFixed(2),
                        item.amount.toFixed(2)
                    ]);

                    doc.autoTable({
                        head,
                        body,
                        startY: currentY,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], fontSize: 10 },
                        bodyStyles: { fontSize: 9, cellPadding: 4 },
                        alternateRowStyles: { fillColor: [248, 252, 249] },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 12 },
                            1: { halign: 'left', cellWidth: 70 },
                            2: { halign: 'center', cellWidth: 18 },
                            3: { halign: 'center', cellWidth: 22 },
                            4: { halign: 'right', cellWidth: 28 },
                            5: { halign: 'right', cellWidth: 30 }
                        }
                    });

                    currentY = doc.autoTable.previous.finalY + 10;

                    // Invoice totals
                    const totalsX = doc.internal.pageSize.getWidth() - 12 - 65;
                    const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Subtotal:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.totalAmount.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 7;
                    doc.text("Previous Balance:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.previousBalance.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 7;
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.setTextColor(40, 167, 69);
                    doc.text("Grand Total:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.grandTotal.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 15;

                    // Add a separator if there are more invoices
                    if (i < invoices.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.5);
                        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
                    }
                }

                // Save the PDF
                const fileName = `Invoices_${partyName.replace(/\s+/g, '_')}_${startDate}_to_${endDate}.pdf`;
                doc.save(fileName);

                statusDiv.innerHTML = `<p style="color: green;">${invoices.length} invoices ka PDF "${fileName}" naam se download ho gaya.</p>`;

            } catch (error) {
                console.error("Party invoices download karne me error:", error);
                statusDiv.innerHTML = `<p style="color: red;">Error: ${error.message || 'Invoices download nahi ho sake.'}</p>`;
            }
        }
        // Initialize the new section
        document.addEventListener('DOMContentLoaded', function() {
            // Set default dates for party invoices (current month)
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('partyInvoicesStartDate').value = firstDayOfMonth.toISOString().slice(0, 10);
            document.getElementById('partyInvoicesEndDate').value = today.toISOString().slice(0, 10);

            // Populate the party list for the new section
            populatePartyListForInvoices();
        });

        // Function to populate the party list for the invoices section
        async function populatePartyListForInvoices() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/parties`);
                if (!response.ok) await handleFetchError(response, "Party list fetch karne me nakami.");
                const parties = await response.json();
                const datalist = document.getElementById('partyListForInvoices');
                datalist.innerHTML = '';

                parties.sort((a, b) => a.name.localeCompare(b.name)).forEach(party => {
                    const option = document.createElement('option');
                    option.value = party.name;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.error("Party list load karne me error:", error);
            }
        }

        // Function to download all invoices for a specific party within a date range
        async function downloadPartyInvoices() {
            const partyName = document.getElementById('partyInvoicesPartyName').value.trim();
            const startDate = document.getElementById('partyInvoicesStartDate').value;
            const endDate = document.getElementById('partyInvoicesEndDate').value;
            const statusDiv = document.getElementById('partyInvoicesStatus');

            if (!partyName) {
                statusDiv.innerHTML = '<p style="color: red;">Barae meharbani party ka naam select karen.</p>';
                return;
            }

            if (!startDate || !endDate) {
                statusDiv.innerHTML = '<p style="color: red;">Barae meharbani start aur end date select karen.</p>';
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                statusDiv.innerHTML = '<p style="color: red;">Start date end date se pehle honi chahiye.</p>';
                return;
            }

            statusDiv.innerHTML = `<p>${partyName} ke invoices fetch ho rahe hain ${startDate} se ${endDate} tak...</p>`;

            try {
                // Fetch invoices for the party within the date range
                // Using the correct API endpoint that filters by party name and date range
                const response = await fetch(`${API_BASE_URL}/api/invoices?startDate=${startDate}&endDate=${endDate}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        statusDiv.innerHTML = `<p>Specified date range me koi invoices nahi mile.</p>`;
                        return;
                    }
                    await handleFetchError(response, "Invoices fetch karne me nakami.");
                }

                const allInvoices = await response.json();

                if (!allInvoices || allInvoices.length === 0) {
                    statusDiv.innerHTML = `<p>Specified date range me koi invoices nahi mile.</p>`;
                    return;
                }

                // Filter invoices by party name on the client side
                const partyInvoices = allInvoices.filter(invoice =>
                    invoice.partyName && invoice.partyName.toLowerCase() === partyName.toLowerCase()
                );

                if (partyInvoices.length === 0) {
                    statusDiv.innerHTML = `<p>${partyName} ke liye specified date range me koi invoices nahi mile.</p>`;
                    return;
                }

                statusDiv.innerHTML = `<p>${partyInvoices.length} invoices mile hain. PDF banayi ja rahi hai...</p>`;

                // Create a new PDF document
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                let currentPage = 1;
                const totalInvoices = partyInvoices.length;

                // Helper function to add header and footer
                const addHeaderFooter = (doc, pageNum, totalPages) => {
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const margin = 12;

                    // Header
                    doc.setFontSize(20);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(40, 167, 69);
                    doc.text(COMPANY_NAME, margin, margin + 5);

                    doc.setFontSize(15);
                    doc.setTextColor(50, 50, 50);
                    const title = `Party Invoices: ${partyName}`;
                    const titleWidth = doc.getTextWidth(title);
                    doc.text(title, pageWidth - margin - titleWidth, margin + 5);

                    doc.setDrawColor(40, 167, 69);
                    doc.setLineWidth(0.6);
                    doc.line(margin, margin + 16, pageWidth - margin, margin + 16);

                    // Footer
                    const footerStartY = doc.internal.pageSize.getHeight() - margin - 18;
                    doc.setDrawColor(40, 167, 69);
                    doc.setLineWidth(0.4);
                    doc.line(margin, footerStartY, pageWidth - margin, footerStartY);

                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth - margin - 20, doc.internal.pageSize.getHeight() - margin + 5);
                };

                // Process each invoice
                for (let i = 0; i < partyInvoices.length; i++) {
                    const invoice = partyInvoices[i];

                    // Add a new page for each invoice (except the first one)
                    if (i > 0) {
                        doc.addPage();
                        currentPage++;
                    }

                    // Add header and footer
                    addHeaderFooter(doc, currentPage, totalInvoices);

                    let currentY = 48;

                    // Invoice details
                    doc.setFontSize(11);
                    doc.setFont("helvetica", "bold");
                    doc.setTextColor(50, 50, 50);
                    doc.text("Bill To:", 12, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.partyName, 12 + 22, currentY, {maxWidth: doc.internal.pageSize.getWidth() / 2 - 12 - 25});

                    doc.setFont("helvetica", "bold");
                    doc.text("Invoice #:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.invoiceNumber.toString(), doc.internal.pageSize.getWidth() / 2 + 40, currentY);

                    currentY += 7;
                    doc.setFont("helvetica", "bold");
                    doc.text("Date:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
                    doc.setFont("helvetica", "normal");
                    doc.text(invoice.date, doc.internal.pageSize.getWidth() / 2 + 40, currentY);

                    currentY += 12;

                    // Invoice items table
                    const head = [['Sr.', 'Product Name', 'Qty', 'Packing', 'Unit Price', 'Amount']];
                    const body = invoice.items.map((item, index) => [
                        index + 1,
                        item.productName,
                        item.qty,
                        item.packing,
                        item.unitPrice.toFixed(2),
                        item.amount.toFixed(2)
                    ]);

                    doc.autoTable({
                        head,
                        body,
                        startY: currentY,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], fontSize: 10 },
                        bodyStyles: { fontSize: 9, cellPadding: 4 },
                        alternateRowStyles: { fillColor: [248, 252, 249] },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 12 },
                            1: { halign: 'left', cellWidth: 70 },
                            2: { halign: 'center', cellWidth: 18 },
                            3: { halign: 'center', cellWidth: 22 },
                            4: { halign: 'right', cellWidth: 28 },
                            5: { halign: 'right', cellWidth: 30 }
                        }
                    });

                    currentY = doc.autoTable.previous.finalY + 10;

                    // Invoice totals
                    const totalsX = doc.internal.pageSize.getWidth() - 12 - 65;
                    const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;

                    doc.setFontSize(10);
                    doc.setFont("helvetica", "normal");
                    doc.text("Subtotal:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.totalAmount.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 7;
                    doc.text("Previous Balance:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.previousBalance.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 7;
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(11);
                    doc.setTextColor(40, 167, 69);
                    doc.text("Grand Total:", totalsX, currentY, { align: 'right' });
                    doc.text(invoice.grandTotal.toFixed(2), amountsX, currentY, { align: 'right' });

                    currentY += 15;

                    // Add a separator if there are more invoices
                    if (i < partyInvoices.length - 1) {
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.5);
                        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
                    }
                }

                // Save the PDF
                const fileName = `Invoices_${partyName.replace(/\s+/g, '_')}_${startDate}_to_${endDate}.pdf`;
                doc.save(fileName);

                statusDiv.innerHTML = `<p style="color: green;">${partyInvoices.length} invoices ka PDF "${fileName}" naam se download ho gaya.</p>`;

            } catch (error) {
                console.error("Party invoices download karne me error:", error);
                statusDiv.innerHTML = `<p style="color: red;">Error: ${error.message || 'Invoices download nahi ho sake.'}</p>`;
            }
        }
        // Function to generate product sales summary with date range
// Updated generateProductSalesSummaryPDFWithDateRange function
async function generateProductSalesSummaryPDFWithDateRange() {
    const startDate = document.getElementById('productSalesStartDate').value;
    const endDate = document.getElementById('productSalesEndDate').value;

    if (!startDate || !endDate) {
        alert("Barae meharbani product sales summary ke liye start aur end date select karen.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date end date se pehle honi chahiye.");
        return;
    }

    showLoadingStatus(`Product sales summary fetch ho rahi hai ${startDate} se ${endDate} tak...`);

    try {
        const response = await fetch(`${API_BASE_URL}/api/invoices?startDate=${startDate}&endDate=${endDate}`);
        if (!response.ok) await handleFetchError(response, "Specified range ke liye invoices fetch karne me nakami.");
        let invoices = await response.json();

        if (!invoices || invoices.length === 0) {
            alert(`Specified date range (${startDate} to ${endDate}) ke liye koi invoices nahi mile.`);
            hideLoadingStatus("Specified range ke liye koi invoices nahi mile.", true);
            return;
        }

        invoices = sortInvoices(invoices);

        // Process product sales data
        const productSalesMap = {};
        let overallTotalAmount = 0;

        invoices.forEach(invoice => {
            invoice.items.forEach(item => {
                const key = `${item.productName}|${item.packing}`;
                if (!productSalesMap[key]) {
                    productSalesMap[key] = {
                        productName: item.productName,
                        packing: item.packing,
                        totalQty: 0,
                        totalAmount: 0
                    };
                }

                productSalesMap[key].totalQty += parseFloat(item.qty) || 0;
                const itemAmount = (parseFloat(item.qty) || 0) * (parseFloat(item.unitPrice) || 0);
                productSalesMap[key].totalAmount += itemAmount;
                overallTotalAmount += itemAmount;
            });
        });

        // Convert to array and sort
        const productSalesData = Object.values(productSalesMap);
        productSalesData.sort((a, b) => a.productName.localeCompare(b.productName));

        hideLoadingStatus(`Generating Product Sales Summary PDF for ${startDate} to ${endDate}...`, false);

        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        let currentY = 48;
        const pdfTitle = `Product Sales Summary (${startDate} to ${endDate})`;

        const summaryPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, {
            pageNumber: 1,
            addHeaderOnEveryPage: true,
            addWatermarkOnEveryPage: true,
            showSignatures: false
        }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, {
            align: 'center'
        });
        currentY += 15;

        const head = [['Sr.', 'Product Name', 'Packing', 'Quantity', 'Total Amount (PKR)']];
        const body = productSalesData.map((item, index) => [
            index + 1,
            item.productName,
            item.packing,
            formatNumberInIndianStyle(item.totalQty), // Indian format
            formatNumberInIndianStyle(item.totalAmount) // Indian format
        ]);

        // Add total row with Indian formatting
        body.push([
            {content: 'TOTAL', colSpan: 4, styles: {halign: 'right', fontStyle: 'bold'}},
            {content: formatNumberInIndianStyle(overallTotalAmount), styles: {halign: 'right', fontStyle: 'bold'}}
        ]);

        if (body.length > 0) {
            doc.autoTable({
                head,
                body,
                startY: currentY,
                ...getPdfTableStyles(PDF_SECONDARY_COLOR),
                columnStyles: {
                    0: {cellWidth: 15, halign: 'center'},
                    1: {cellWidth: 70, halign: 'left'},
                    2: {cellWidth: 30, halign: 'center'},
                    3: {cellWidth: 30, halign: 'center'},
                    4: {cellWidth: 35, halign: 'right'}
                },
                didDrawPage: summaryPageHook
            });
        } else {
            doc.setFontSize(9.5);
            doc.setFont("helvetica", "italic");
            doc.text("No product sales data to display.", 12, currentY);
        }

        doc.save(`Product_Sales_Summary_${startDate}_to_${endDate}.pdf`);
        hideLoadingStatus("Product Sales Summary PDF generated.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}
// Updated downloadPartyPaymentsPDF function with Indian number formatting
async function downloadPartyPaymentsPDF() {
    const partyName = partySearchInputForPayments.value.trim();

    if (!partyName) {
        alert("Barae meharbani payments download karne ke liye party ka naam darj karen.");
        return;
    }

    showLoadingStatus(`${partyName} ki payments PDF ban rahi hai...`);

    try {
        // Fetch payments for the specific party
        const response = await fetch(`${API_BASE_URL}/api/payments?partyName=${encodeURIComponent(partyName)}`);
        if (!response.ok) {
            if (response.status === 404) throw new Error(`Party "${partyName}" ke liye koi payments nahi mile.`);
            await handleFetchError(response, `Payments fetch karne me nakami.`);
        }

        const payments = await response.json();

        if (!payments || payments.length === 0) {
            alert(`Party "${partyName}" ke liye koi payments nahi mile download karne ke liye.`);
            hideLoadingStatus(`Party "${partyName}" ke liye koi payments nahi mile.`, true);
            return;
        }

        // Sort payments by date
        payments.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Create PDF
        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });
        let currentY = 48;
        const pdfTitle = `Payments for ${partyName}`;
        const commonPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };
        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        // Updated font size and styling
        doc.setFontSize(16); // Increased font size for better visibility
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 12;

        const head = [['Sr.', 'Date', 'Remarks', 'Amount (PKR)']];
        const body = payments.map((payment, index) => [
            index + 1,
            payment.date,
            payment.remarks || '',
            formatNumberInIndianStyle(payment.amount) // Indian format applied here
        ]);

        // Calculate total amount
        const totalAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

        doc.autoTable({
            head,
            body,
            startY: currentY,
            theme: 'grid',
            headStyles: {
                fillColor: PDF_PRIMARY_COLOR,
                fontSize: 11, // Slightly larger font
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            bodyStyles: {
                fontSize: 10, // Slightly larger font
                cellPadding: 2,
                textColor: PDF_TEXT_COLOR
            },
            alternateRowStyles: { fillColor: PDF_TABLE_ALT_ROW_BG },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' },
                1: { cellWidth: 30, halign: 'center' },
                2: { cellWidth: 80, halign: 'left' },
                3: { cellWidth: 35, halign: 'right' } // Increased width for Indian format
            },
            didDrawPage: commonPageHook
        });

        currentY = doc.autoTable.previous.finalY + 15;

        // Add total amount with better styling
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);

        // Add a separator line
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.5);
        doc.line(doc.internal.pageSize.getWidth() - 100, currentY - 5, doc.internal.pageSize.getWidth() - 12, currentY - 5);

        const totalLabel = "Total Amount:";
        const totalAmountStr = formatNumberInIndianStyle(totalAmount); // Indian format applied here

        // Calculate positions
        const totalLabelWidth = doc.getTextWidth(totalLabel);
        const totalAmountWidth = doc.getTextWidth(totalAmountStr);

        // Position the total at the right side
        const totalX = doc.internal.pageSize.getWidth() - 12 - totalAmountWidth;
        const labelX = totalX - totalLabelWidth - 5;

        doc.text(totalLabel, labelX, currentY);
        doc.text(totalAmountStr, totalX, currentY);

        currentY += 8;

        // Add another line below total
        doc.setDrawColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setLineWidth(0.5);
        doc.line(doc.internal.pageSize.getWidth() - 100, currentY, doc.internal.pageSize.getWidth() - 12, currentY);

        // Add payment summary
        currentY += 15;
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);
        doc.text("Payment Summary:", 12, currentY);

        currentY += 6;
        doc.setFont("helvetica", "normal");
        doc.text(`Total Payments: ${payments.length}`, 12, currentY);

        currentY += 5;
        doc.text(`Period: ${payments[0].date} to ${payments[payments.length - 1].date}`, 12, currentY);

        doc.save(`Payments_${partyName.replace(/\s+/g, '_')}.pdf`);
        hideLoadingStatus(`${partyName} ki payments PDF kamyabi se download ho gayi.`, false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}

// Agar aapko simple version chahiye, toh yeh use karen:
async function downloadPartyPaymentsPDF() {
    const partyName = partySearchInputForPayments.value.trim();

    if (!partyName) {
        alert("Barae meharbani payments download karne ke liye party ka naam darj karen.");
        return;
    }

    showLoadingStatus(`${partyName} ki payments PDF ban rahi hai...`);

    try {
        const response = await fetch(`${API_BASE_URL}/api/payments?partyName=${encodeURIComponent(partyName)}`);
        if (!response.ok) {
            if (response.status === 404) throw new Error(`Party "${partyName}" ke liye koi payments nahi mile.`);
            await handleFetchError(response, `Payments fetch karne me nakami.`);
        }

        const payments = await response.json();

        if (!payments || payments.length === 0) {
            alert(`Party "${partyName}" ke liye koi payments nahi mile download karne ke liye.`);
            hideLoadingStatus(`Party "${partyName}" ke liye koi payments nahi mile.`, true);
            return;
        }

        payments.sort((a, b) => new Date(a.date) - new Date(b.date));

        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });
        let currentY = 48;
        const pdfTitle = `Payments for ${partyName}`;
        const commonPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 12;

        const head = [['Sr.', 'Date', 'Remarks', 'Amount (PKR)']];
        const body = payments.map((payment, index) => [
            index + 1,
            payment.date,
            payment.remarks || '',
            formatNumberInIndianStyle(payment.amount) // Indian format yahan apply hua
        ]);

        const totalAmount = payments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);

        doc.autoTable({
            head,
            body,
            startY: currentY,
            theme: 'grid',
            headStyles: { fillColor: PDF_PRIMARY_COLOR, fontSize: 10 },
            bodyStyles: { fontSize: 9, cellPadding: 1.5 },
            alternateRowStyles: { fillColor: PDF_TABLE_ALT_ROW_BG },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' },
                1: { cellWidth: 30, halign: 'center' },
                2: { cellWidth: 80, halign: 'left' },
                3: { cellWidth: 30, halign: 'right' }
            },
            didDrawPage: commonPageHook
        });

        currentY = doc.autoTable.previous.finalY + 12;

        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);

        const totalLabel = "Total Amount:";
        const totalAmountStr = formatNumberInIndianStyle(totalAmount); // Indian format yahan bhi

        const totalLabelWidth = doc.getTextWidth(totalLabel);
        const totalAmountWidth = doc.getTextWidth(totalAmountStr);

        doc.text(totalLabel, doc.internal.pageSize.getWidth() - 12 - totalAmountWidth - totalLabelWidth - 5, currentY);
        doc.text(totalAmountStr, doc.internal.pageSize.getWidth() - 12 - totalAmountWidth, currentY);

        doc.save(`Payments_${partyName.replace(/\s+/g, '_')}.pdf`);
        hideLoadingStatus(`${partyName} ki payments PDF kamyabi se download ho gayi.`, false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}

        async function loadPdfAssets() {
            showLoadingStatus("PDF assets load ho rahe hain...");
            const loadImageAsBase64 = async (url) => {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Local path se image load karne me nakami: ${url}.`);
                        return null;
                    }
                    const blob = await response.blob();
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = (err) => {
                            console.error(`FileReader error for ${url}:`, err);
                            resolve(null);
                        };
                        reader.readAsDataURL(blob);
                    });
                } catch (error) {
                    console.error(`Error fetching local image ${url}:`, error);
                    return null;
                }
            };
            try {
                const logoUrl = 'logo.png';
                const signatureUrl = 'Asim Siganture.jpg';
                [logoBase64, signatureBase64] = await Promise.all([
                    loadImageAsBase64(logoUrl),
                    loadImageAsBase64(signatureUrl)
                ]);
                let statusMessage = "PDF assets load ho gaye.";
                if (!logoBase64) statusMessage = "Warning: logo.png load nahi ho saki. PDF watermark nahi aayega.";
                if (!signatureBase64) statusMessage += " Warning: Asim Siganture.jpg load nahi ho saki. Signature nahi aayega.";
                hideLoadingStatus(statusMessage, !(logoBase64 && signatureBase64));
            } catch (e) {
                hideLoadingStatus(e, true);
            }
        }
                function addPdfHeaderAndFooter(doc, data, title = "Invoice", isContinuation = false) {
            const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 12;
            if (pageNumber === 1 || !isContinuation || (data && data.addHeaderOnEveryPage)) {
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(...PDF_PRIMARY_COLOR);
                doc.text(COMPANY_NAME, margin, margin + 5);
                doc.setFontSize(15);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(...PDF_TEXT_COLOR);
                const titleWidth = doc.getTextWidth(title);
                doc.text(title, pageWidth - margin - titleWidth, margin + 5);
                doc.setDrawColor(...PDF_PRIMARY_COLOR);
                doc.setLineWidth(0.6);
                doc.line(margin, margin + 16, pageWidth - margin, margin + 16);
            }
                        if (logoBase64) {
                try {
                    const imgProps = doc.getImageProperties(logoBase64);
                    const aspectRatio = imgProps.width / imgProps.height;
                    let watermarkWidth = pageWidth / 1.8;
                    let watermarkHeight = watermarkWidth / aspectRatio;
                    const watermarkX = (pageWidth - watermarkWidth) / 2;
                    const watermarkY = (pageHeight - watermarkHeight) / 2;
                    doc.saveGraphicsState();
                    doc.setGState(new doc.GState({ opacity: 0.15 }));
                    doc.addImage(logoBase64, 'PNG', watermarkX, watermarkY, watermarkWidth, watermarkHeight, 'WATERMARK_LOGO');
                    doc.restoreGraphicsState();
                } catch (e) {
                    console.error("Watermark add karne me error:", e);
                }
            }
            const footerStartY = pageHeight - margin - 18;
            doc.setDrawColor(...PDF_PRIMARY_COLOR);
            doc.setLineWidth(0.4);
            doc.line(margin, footerStartY, pageWidth - margin, footerStartY);
            const sigAreaWidth = (pageWidth - (2 * margin) - 10) / 2;
            const accountantSigX = margin;
            const receiverSigX = margin + sigAreaWidth + 10;
            doc.setFontSize(8.5);
            doc.setTextColor(...PDF_MUTED_TEXT_COLOR);
            if (data?.showSignatures !== false) {
                if (signatureBase64) {
                    try {
                        const sigImgProps = doc.getImageProperties(signatureBase64);
                        let sigHeight = 12;
                        let sigWidth = sigImgProps.width * sigHeight / sigImgProps.height;
                        if(sigWidth > sigAreaWidth - 15) {
                            sigWidth = sigAreaWidth - 15;
                            sigHeight = sigWidth / (sigImgProps.width / sigImgProps.height);
                        }
                                                const actualAccountantSigX = accountantSigX + (sigAreaWidth - sigWidth) / 2;
                        const sigImageY = footerStartY - sigHeight - 2;
                        doc.addImage(signatureBase64, 'JPEG', actualAccountantSigX, sigImageY, sigWidth, sigHeight, 'ACCOUNTANT_SIG');
                    } catch (e) {
                        console.error("Signature image add karne me error:", e);
                    }
                }
                doc.text("Accountant Signature", accountantSigX + sigAreaWidth / 2, footerStartY + 8, { align: 'center' });
                doc.text("Receiver Signature", receiverSigX + sigAreaWidth / 2, footerStartY + 8, { align: 'center' });

            }
                        const bottomTextY = pageHeight - margin + 5;
            doc.setFontSize(8);
            doc.text(NUTRION_ADDRESS, margin, bottomTextY);
            const contactWidth = doc.getTextWidth(NUTRION_CONTACT);
            doc.text(NUTRION_CONTACT, (pageWidth - contactWidth) / 2, bottomTextY);
            const pageNumText = `Page ${pageNumber}`;
            const pageNumWidth = doc.getTextWidth(pageNumText);
            doc.text(pageNumText, pageWidth - margin - pageNumWidth, bottomTextY);

        }
        async function initializeApp() {
            showLoadingStatus("Application initialize ho rahi hai...");
            dateInput.value = new Date().toISOString().slice(0, 10);
            paymentDateInput.value = new Date().toISOString().slice(0, 10);
            const today = new Date().toISOString().slice(0, 10);
            const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0, 10);
            paymentStartDateInput.value = firstDayOfMonth;
            paymentEndDateInput.value = today;
            invoiceStartDateInput.value = firstDayOfMonth;
            invoiceEndDateInput.value = today;
            try {
                await loadPdfAssets();
                await fetchAndSetNextInvoiceNumber();
                await populatePartyLists();
                await populateProductDatalist();
                await fetchStockData();
                addNewInvoiceItemRow();
                addNewStockRow();
                hideLoadingStatus("Application kamyabi se initialize ho gayi.", false);
            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }
        async function fetchAndSetNextInvoiceNumber() {
            if (currentEditingInvoiceNumber) return;
            try {
                const response = await fetch(`${API_BASE_URL}/api/next-invoice-number`);
                if (!response.ok) await handleFetchError(response, "Agla invoice number fetch karne me nakami.");
                const data = await response.json();
                invoiceNumberInput.value = data.nextInvoiceNumber;
            } catch (error) {
                invoiceNumberInput.value = "Error";
                hideLoadingStatus(error, true);
            }
        }
        async function populatePartyLists() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/parties`);
                if (!response.ok) await handleFetchError(response, "Party list fetch karne me nakami.");
                const parties = await response.json();
                partyListForInvoiceDatalist.innerHTML = '';
                partyListForPaymentDatalist.innerHTML = '';
                partyListForSearchDatalist.innerHTML = '';
                partyListForSearchPaymentsDatalist.innerHTML = '';
                partyListForSearchHistoryDatalist.innerHTML = '';
                parties.sort((a,b) => a.name.localeCompare(b.name)).forEach(party => {
                    const option = document.createElement('option');
                    option.value = party.name;
                    partyListForInvoiceDatalist.appendChild(option.cloneNode(true));
                    partyListForPaymentDatalist.appendChild(option.cloneNode(true));
                    partyListForSearchDatalist.appendChild(option.cloneNode(true));
                    partyListForSearchPaymentsDatalist.appendChild(option.cloneNode(true));
                    partyListForSearchHistoryDatalist.appendChild(option.cloneNode(true));
                });
            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }
        async function populateProductDatalist() {
            const productDatalist = document.createElement('datalist');
            productDatalist.id = 'productListGlobal';
            [...productOptionsCache].sort((a,b) => a.localeCompare(b)).forEach(productName => {
                const option = document.createElement('option');
                option.value = productName;
                productDatalist.appendChild(option);
            });
            document.body.appendChild(productDatalist);
        }
        async function handlePartyChange() {
            const partyName = partyInput.value.trim();
            if (!partyName) {
                prevBalanceInput.value = "0.00";
                currentPartyInitialBalance = 0.0;
                makePrevBalanceReadOnly(true);
                updateGrandTotal();
                return;
            }
            showLoadingStatus(`${partyName} ka balance fetch ho raha hai...`);
            try {
                const response = await fetch(`${API_BASE_URL}/api/party-balance?partyName=${encodeURIComponent(partyName)}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        prevBalanceInput.value = "0.00";
                        currentPartyInitialBalance = 0.0;
                        makePrevBalanceReadOnly(false);
                        hideLoadingStatus(`Party "${partyName}" pehli baar istemal ho rahi hai. Balance 0.00 set kiya gaya.`, false);
                    } else {
                        await handleFetchError(response, `${partyName} ka balance fetch karne me nakami.`);
                        prevBalanceInput.value = "0.00";
                        currentPartyInitialBalance = 0.0;
                        makePrevBalanceReadOnly(false);
                    }
                } else {
                    const data = await response.json();
                    prevBalanceInput.value = parseFloat(data.balance).toFixed(2);
                    currentPartyInitialBalance = parseFloat(data.initialOpeningBalance) || 0.0;
                    makePrevBalanceReadOnly(true);
                    hideLoadingStatus(`${partyName} ka mojooda balance load ho gaya.`, false);
                }
            } catch (error) {
                prevBalanceInput.value = "0.00";
                currentPartyInitialBalance = 0.0;
                makePrevBalanceReadOnly(false);
                hideLoadingStatus(error, true);
            }
            updateGrandTotal();
        }
        async function togglePrevBalanceEdit() {
            const isReadOnly = prevBalanceInput.readOnly;
            const partyName = partyInput.value.trim();
            if (!partyName) {
                alert("Barae meharbani pehle party ka naam select karen.");
                return;
            }
            if (!isReadOnly) {
                const newBalance = parseFloat(prevBalanceInput.value);
                if (isNaN(newBalance)) {
                    alert("Barae meharbani sahi balance darj karen.");
                    prevBalanceInput.focus();
                    return;
                }
                const reason = prompt("Opening Balance change karne ki wajah darj karen (optional):");
                showLoadingStatus(`Party "${partyName}" ka opening balance update ho raha hai...`);
                try {
                    const response = await fetch(`${API_BASE_URL}/api/parties/${encodeURIComponent(partyName)}/set-prev-balance`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prevBalance: newBalance, reason: reason })
                    });
                    if (!response.ok) await handleFetchError(response, `Opening balance update karne me nakami.`);
                    const result = await response.json();
                    currentPartyInitialBalance = newBalance;
                    prevBalanceInput.value = newBalance.toFixed(2);
                    makePrevBalanceReadOnly(true);
                    updateGrandTotal();
                    hideLoadingStatus(result.message || `Opening balance for "${partyName}" updated to ${newBalance.toFixed(2)}.`, false);
                    if (partySearchInput.value === partyName && ledgerDisplayArea.innerHTML.includes(partyName)) await displayPartyLedger();
                    if (partySearchInputForHistory.value === partyName && openingBalanceHistoryArea.innerHTML.includes(partyName)) await displayOpeningBalanceHistory();
                } catch (error) {
                    hideLoadingStatus(error, true);
                    makePrevBalanceReadOnly(false);
                }
            } else {
                makePrevBalanceReadOnly(false);
                prevBalanceInput.focus();
            }
        }
        function makePrevBalanceReadOnly(isReadOnly) {
            prevBalanceInput.readOnly = isReadOnly;
            prevBalanceInput.classList.toggle('editable', !isReadOnly);
            prevBalanceInput.classList.toggle('conditionally-readonly', isReadOnly);
            editPrevBalanceBtn.textContent = isReadOnly ? "Edit" : "Lock";
            editPrevBalanceBtn.classList.toggle('btn-warning', !isReadOnly);
            editPrevBalanceBtn.classList.toggle('btn-secondary', isReadOnly);
        }
        function addNewInvoiceItemRow(itemData = null) {
            if (rowsContainer.children.length >= MAX_INVOICE_ITEMS_CAP && !itemData) {
                alert(`Invoice me zada se zada ${MAX_INVOICE_ITEMS_CAP} items ki ijazat hai.`);
                return;
            }
            const row = document.createElement('tr');
            row.classList.add('item-entry-row');
            row.innerHTML = `<td><span class="sr-no">${itemSrNo}</span></td><td><input type="text" class="product-name" list="productListGlobal" placeholder="Product Name" value="${itemData ? itemData.productName : ''}"></td><td><input type="number" class="qty" placeholder="0" min="0" value="${itemData ? itemData.qty : ''}"></td><td><select class="packing">${packingOptions.map(opt => `<option value="${opt}" ${itemData && itemData.packing === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select></td><td><input type="number" class="unit-price" placeholder="0.00" min="0" step="0.01" value="${itemData ? itemData.unitPrice : ''}"></td><td><input type="text" class="amount" readonly value="${itemData ? itemData.amount.toFixed(2) : '0.00'}"></td><td><button type="button" class="remove-row-btn" onclick="removeInvoiceItemRow(this)">X</button></td>`;
            rowsContainer.appendChild(row);
            itemSrNo++;
            updateSerialNumbers();
            row.querySelectorAll('.qty, .unit-price, .product-name').forEach(input => {
                input.addEventListener('input', updateInvoiceTotals);
                if (input.classList.contains('product-name')) input.addEventListener('change', handleProductSelectionChange);
            });
            if (!itemData) handleProductSelectionChange({ target: row.querySelector('.product-name') });
        }
        function handleProductSelectionChange(event) {
            const productNameInput = event.target;
            const row = productNameInput.closest('tr');
            const packingSelect = row.querySelector('.packing');
            const selectedProduct = productNameInput.value;
            if (productPackingMap[selectedProduct]) packingSelect.value = productPackingMap[selectedProduct];
        }
        function removeInvoiceItemRow(button) {
            button.closest('tr').remove();
            updateInvoiceTotals();
            updateSerialNumbers();
        }
        function updateSerialNumbers() {
            const rows = rowsContainer.querySelectorAll('tr.item-entry-row');
            rows.forEach((row, index) => {
                row.querySelector('.sr-no').textContent = index + 1;
            });
            itemSrNo = rows.length + 1;
        }
        function updateInvoiceTotals() {
    let totalAmount = 0;
    rowsContainer.querySelectorAll('tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
        const amount = qty * unitPrice;
        row.querySelector('.amount').value = amount.toFixed(2);
        totalAmount += amount;
    });
    totalAmountSpan.textContent = totalAmount.toFixed(2);

    // Calculate GST amount according to the specified formula
    const gstPercentage = parseFloat(gstPercentageInput.value) || 0;

    // Step 1: Multiply Quantity × Unit Price (already done as totalAmount)
    // Step 2: Subtract GST (18%) from this total to get the new unit price
    const amountBeforeGST = totalAmount;
    const gstAmount = (amountBeforeGST * gstPercentage) / 100;
    const amountAfterGST = amountBeforeGST - gstAmount;

    // Step 3: Treat amountAfterGST as the new unit price
    // Step 4: Add back the deducted GST amount to get the Invoice Subtotal
    const invoiceSubtotal = amountAfterGST + gstAmount;

    // For display purposes, we'll show the GST amount and the final total
    gstAmountSpan.textContent = gstAmount.toFixed(2);

    updateGrandTotal();
}
        function updateGrandTotal() {
            const total = parseFloat(totalAmountSpan.textContent) || 0;
            const gstAmount = parseFloat(gstAmountSpan.textContent) || 0;
            const prevBal = parseFloat(prevBalanceInput.value) || 0;
            grandTotalSpan.textContent = (total + gstAmount + prevBal).toFixed(2);
        }

        // Add event listener for GST percentage change
        gstPercentageInput.addEventListener('input', updateInvoiceTotals);
        prevBalanceInput.addEventListener('input', updateGrandTotal);

        async function saveInvoice() {
            const partyName = partyInput.value.trim();
            if (!partyName) {
                alert("Party ka naam zaroori hai.");
                partyInput.focus();
                return;
            }
            const items = [];
            let formIsValid = true;
            rowsContainer.querySelectorAll('tr').forEach(row => {
                const productName = row.querySelector('.product-name').value.trim();
                const qty = parseFloat(row.querySelector('.qty').value);
                const packing = row.querySelector('.packing').value;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value);
                if (productName && (isNaN(qty) || qty <= 0 || isNaN(unitPrice) || unitPrice < 0)) {
                    formIsValid = false;
                    alert(`"${productName}" ke liye Quantity aur Unit Price sahi tarah darj karen.`);
                    return;
                }
                if (productName) items.push({
                    productName,
                    qty,
                    packing,
                    unitPrice,
                    amount: qty * unitPrice
                });
            });
            if (!formIsValid) return;
            if (items.length === 0) {
                alert("Barae meharbani items add karen ya form clear karen.");
                return;
            }

            // Get GST values
            const gstPercentage = parseFloat(gstPercentageInput.value) || 0;
            const gstAmount = parseFloat(gstAmountSpan.textContent) || 0;

            const invoiceData = {
                partyName,
                date: dateInput.value,
                invoiceNumber: invoiceNumberInput.value,
                items,
                // Frontend sends calculated totals, but backend recalculates for accuracy
                totalAmount: parseFloat(totalAmountSpan.textContent),
                gstPercentage: gstPercentage,
                gstAmount: gstAmount,
                previousBalance: parseFloat(prevBalanceInput.value), // Send the value from the input
                grandTotal: parseFloat(grandTotalSpan.textContent) // Send the value from the input
            };
            const apiEndpoint = currentEditingInvoiceNumber ? `${API_BASE_URL}/api/invoices/${currentEditingInvoiceNumber}` : `${API_BASE_URL}/api/invoices`;
            const method = currentEditingInvoiceNumber ? 'PUT' : 'POST';
            showLoadingStatus(currentEditingInvoiceNumber ? "Invoice update ho raha hai..." : "Invoice save ho raha hai...");
            try {
                const response = await fetch(apiEndpoint, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(invoiceData)
                });
                if (!response.ok) await handleFetchError(response, `Invoice ${currentEditingInvoiceNumber ? 'update' : 'save'} karne me nakami.`);
                const result = await response.json();
                hideLoadingStatus(result.message || `Invoice ${currentEditingInvoiceNumber ? 'update' : 'saved'} ho gaya! #: ${result.invoiceNumber || invoiceData.invoiceNumber}`, false);

                if (invoiceData.items.length > 0) {
                    const stockDeductions = invoiceData.items.map(item => ({ productName: item.productName, qty: item.qty }));
                    try {
                        const stockResponse = await fetch(`${API_BASE_URL}/api/stock/deduct`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items: stockDeductions }) });
                        if (!stockResponse.ok) {
                             const stockError = await stockResponse.json();
                             throw new Error(stockError.message || 'Stock deduction me nakami.');
                        }
                        await fetchStockData();
                    } catch (stockError) {
                        alert(`Warning: Invoice save ho gaya, lekin stock update nahi ho saka. Barae meharbani stock check karen. Wajah: ${stockError.message}`);
                    }
                }

                const processedPartyName = invoiceData.partyName;
                if (currentEditingInvoiceNumber) {
                    resetInvoiceForm(true);
                } else {
                    invoiceNumberInput.value = result.nextInvoiceNumber || (parseInt(invoiceData.invoiceNumber, 10) + 1).toString();
                    rowsContainer.innerHTML = '';
                    itemSrNo = 1;
                    addNewInvoiceItemRow();
                    dateInput.value = new Date().toISOString().slice(0, 10);
                    // After saving a new invoice, fetch the updated balance for the current party
                    if (partyInput.value === processedPartyName) {
                         await handlePartyChange(); // This will fetch the correct new balance
                    } else if (!partyInput.value) {
                        prevBalanceInput.value = "0.00";
                        makePrevBalanceReadOnly(true);
                    }
                    updateInvoiceTotals(); // Recalculate grand total based on potentially new prev balance
                    await populatePartyLists();
                }
                // Refresh ledger and payments display if the party is currently being viewed
                if (partySearchInput.value === processedPartyName && ledgerDisplayArea.innerHTML.includes(processedPartyName)) {
                     await displayPartyLedger();
                }
                if (partySearchInputForPayments.value === processedPartyName && paymentDisplayArea.innerHTML.includes(processedPartyName)) {
                    await displayPartyPaymentsForDeletion();
                }
                 // Also refresh the party list as a party might be removed if this was their last transaction
                await populatePartyLists();

            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }

        async function searchInvoiceToEdit() {
            const invoiceNumToSearch = searchInvoiceNumberInputEl.value.trim();
            if (!invoiceNumToSearch) {
                alert("Barae meharbani update karne ke liye Invoice Number likhen.");
                return;
            }
            showLoadingStatus(`Invoice #${invoiceNumToSearch} search ho raha hai...`);
            try {
                const response = await fetch(`${API_BASE_URL}/api/invoices/${encodeURIComponent(invoiceNumToSearch)}`);
                if (!response.ok) {
                     if (response.status === 404) throw new Error(`Invoice #${invoiceNumToSearch} nahi mila.`);
                     await handleFetchError(response, `Invoice search karne me error.`);
                }
                const invoiceData = await response.json();
                loadInvoiceDataIntoForm(invoiceData);
                currentEditingInvoiceNumber = invoiceData.invoiceNumber;
                invoiceFormTitle.textContent = `Editing Invoice #${invoiceData.invoiceNumber}`;
                saveOrUpdateInvoiceBtn.textContent = "Update Invoice";
                saveOrUpdateInvoiceBtn.classList.remove('btn-success');
                saveOrUpdateInvoiceBtn.classList.add('btn-warning');
                invoiceNumberInput.classList.add('conditionally-readonly');
                invoiceNumberInput.readOnly = true;
                deleteInvoiceBtn.style.display = 'inline-block';
                hideLoadingStatus(`Invoice #${invoiceNumToSearch} kamyabi se load ho gaya.`, false);
                searchInvoiceNumberInputEl.value = '';
                document.getElementById('invoiceTable').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                hideLoadingStatus(error, true);
                resetInvoiceForm(true);
            }
        }

        function loadInvoiceDataIntoForm(invoiceData) {
            partyInput.value = invoiceData.partyName;
            dateInput.value = invoiceData.date;
            invoiceNumberInput.value = invoiceData.invoiceNumber;
            // When loading for edit, use the previousBalance stored with the invoice
            prevBalanceInput.value = parseFloat(invoiceData.previousBalance).toFixed(2);
            // Set GST values if they exist in the invoice data
            if (invoiceData.gstPercentage !== undefined) {
                gstPercentageInput.value = invoiceData.gstPercentage;
            }
            if (invoiceData.gstAmount !== undefined) {
                gstAmountSpan.textContent = parseFloat(invoiceData.gstAmount).toFixed(2);
            }
            // We don't fetch initial balance here, as the previousBalance on the invoice is the relevant starting point for THIS invoice.
            // The initial balance is only relevant when creating a *new* invoice or viewing the full ledger.
            makePrevBalanceReadOnly(true); // Keep it read-only by default when loading
            rowsContainer.innerHTML = '';
            itemSrNo = 1;
            if (invoiceData.items && invoiceData.items.length > 0) {
                invoiceData.items.forEach(item => addNewInvoiceItemRow(item));
            } else {
                addNewInvoiceItemRow();
            }
            updateInvoiceTotals(); // This will calculate grand total based on loaded prev balance
        }

        async function resetInvoiceForm(fullReset = true) {
            const currentPartyInForm = partyInput.value;
            if (fullReset) {
                partyInput.value = '';
                searchInvoiceNumberInputEl.value = '';
                currentEditingInvoiceNumber = null;
                invoiceNumberInput.readOnly = true;
                prevBalanceInput.value = "0.00";
                gstPercentageInput.value = "00";
                gstAmountSpan.textContent = "0.00";
                currentPartyInitialBalance = 0.0; // Reset initial balance state
                makePrevBalanceReadOnly(true);
                try {
                    await fetchAndSetNextInvoiceNumber();
                } catch (e) { /* handled */ }
                invoiceFormTitle.textContent = "Create New Invoice";
                saveOrUpdateInvoiceBtn.textContent = "Save Invoice";
                saveOrUpdateInvoiceBtn.classList.remove('btn-warning');
                saveOrUpdateInvoiceBtn.classList.add('btn-success');
                deleteInvoiceBtn.style.display = 'none';
            }
            dateInput.value = new Date().toISOString().slice(0, 10);
            rowsContainer.innerHTML = '';
            itemSrNo = 1;
            addNewInvoiceItemRow();
            if (!fullReset && currentPartyInForm) {
                partyInput.value = currentPartyInForm;
                await handlePartyChange(); // Fetch correct current balance for the party
            } else {
                updateGrandTotal(); // Recalculate grand total based on 0 prev balance
            }
            updateInvoiceTotals();
            if(fullReset) hideLoadingStatus("Invoice form clear ho gaya.", false);
        }

        async function deleteLoadedInvoice() {
            if (!currentEditingInvoiceNumber) {
                alert("Koi invoice load nahi hai delete karne ke liye.");
                return;
            }

            if (!confirm(`Kya aap waqai Invoice #${currentEditingInvoiceNumber} delete karna chahte hain? Yeh action reverse nahi kiya ja sakta.`)) {
                return;
            }

            showLoadingStatus(`Invoice #${currentEditingInvoiceNumber} delete ho raha hai...`);
            try {
                const response = await fetch(`${API_BASE_URL}/api/invoices/${encodeURIComponent(currentEditingInvoiceNumber)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    await handleFetchError(response, `Invoice #${currentEditingInvoiceNumber} delete karne me nakami.`);
                }

                const result = await response.json();
                hideLoadingStatus(result.message || `Invoice #${currentEditingInvoiceNumber} kamyabi se delete ho gaya.`, false);

                resetInvoiceForm(true);

                // Refresh ledger and payments display if the party was being viewed
                if (partySearchInput.value === result.partyName && ledgerDisplayArea.innerHTML.includes(result.partyName)) {
                     await displayPartyLedger();
                }
                if (partySearchInputForPayments.value === result.partyName && paymentDisplayArea.innerHTML.includes(result.partyName)) {
                    await displayPartyPaymentsForDeletion();
                }
                 // Also refresh the party list as a party might be removed if this was their last transaction
                await populatePartyLists();


            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }

        async function recordPayment() {
            const partyName = paymentPartyNameInput.value.trim();
            const amountStr = paymentAmountInput.value;
            const date = paymentDateInput.value;
            const remarks = paymentRemarksInput.value.trim();

            if (!partyName) {
                alert("Party ka naam zaroori hai.");
                paymentPartyNameInput.focus();
                return;
            }
            if (!amountStr) {
                alert("Amount zaroori hai.");
                paymentAmountInput.focus();
                return;
            }
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) {
                alert("Amount positive number hona chahiye.");
                paymentAmountInput.focus();
                return;
            }
            if (!date) {
                alert("Payment ki date zaroori hai.");
                paymentDateInput.focus();
                return;
            }

            const paymentData = {
                partyName,
                amount,
                date,
                remarks
            };
            showLoadingStatus("Payment record ho rahi hai...");
            try {
                const response = await fetch(`${API_BASE_URL}/api/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });
                if (!response.ok) await handleFetchError(response, "Payment record karne me nakami.");
                const result = await response.json();
                hideLoadingStatus(result.message || "Payment kamyabi se record ho gayi!", false);
                lastPaymentDetails = { ...paymentData,
                    paymentId: result.paymentId || Date.now()
                };
                downloadPaymentReceiptBtn.style.display = 'inline-block';
                paymentPartyNameInput.value = '';
                paymentAmountInput.value = '';
                paymentRemarksInput.value = '';
                // After recording payment, refresh the balance for the current party in the invoice form
                if (partyInput.value === partyName) await handlePartyChange();
                // Refresh ledger and payments display if the party is currently being viewed
                if (partySearchInput.value === partyName && ledgerDisplayArea.innerHTML.includes(partyName)) {
                    await displayPartyLedger();
                }
                if (partySearchInputForPayments.value === partyName && paymentDisplayArea.innerHTML.includes(partyName)) {
                    await displayPartyPaymentsForDeletion();
                }
                 // Also refresh the party list as a new party might have been created
                await populatePartyLists();

            } catch (error) {
                hideLoadingStatus(error, true);
                downloadPaymentReceiptBtn.style.display = 'none';
            }
        }

        // --- FIXED: displayPartyLedger to show running balance, correct columns, and Unit Price ---
        /**
         * Fetches and displays the detailed transaction ledger for a party.
         * Data is sorted chronologically (oldest to newest).
         */
     async function displayPartyLedger() {
    const partyName = partySearchInput.value.trim();
    if (!partyName) {
        alert("Barae meharbani ledger dekhne ke liye party ka naam darj karen.");
        ledgerDisplayArea.innerHTML = '<p>Barae meharbani search karne ke liye party ka naam darj karen.</p>';
        downloadLedgerPdfBtn.style.display = 'none';
        currentLedgerDataForPDF = null;
        return;
    }

    showLoadingStatus(`${partyName} ka ledger fetch ho raha hai...`);
    ledgerDisplayArea.innerHTML = `<p><strong>${partyName}</strong> ke liye ledger load ho raha hai...</p>`;

    try {
        const response = await fetch(`${API_BASE_URL}/api/ledger/${encodeURIComponent(partyName)}`);
        if (!response.ok) {
            if (response.status === 404) throw new Error(`Party "${partyName}" ke liye koi ledger nahi mila.`);
            await handleFetchError(response, `Ledger fetch karne me nakami.`);
        }

        const ledgerData = await response.json();
        const transactions = (ledgerData.transactions || []).sort((a, b) => new Date(a.date) - new Date(b.date));

        let runningBalance = ledgerData.openingBalance || 0;
        let totalDebit = 0;
        let totalCredit = 0;

        let ledgerHTML = `<h4>Transaction Ledger for: ${ledgerData.partyName}</h4>`;
        ledgerHTML += `<table class="new-ledger-table">
            <thead>
                <tr>
                    <th class="text-center">Date</th>
                    <th class="text-center">Invoice #</th>
                    <th>Product Name</th>
                    <th class="text-center">Qty</th>
                    <th class="text-center">Packing</th>
                    <th class="text-right">Unit Price</th>
                    <th class="text-right">Debit</th>
                    <th class="text-right">Credit</th>
                    <th class="text-right">Balance</th>
                </tr>
            </thead>
            <tbody>`;

        // Opening Balance Row with Indian formatting
        ledgerHTML += `<tr class="opening-balance-row">
            <td colspan="8" class="text-right">Previous Balance</td>
            <td class="text-right">${formatNumberInIndianStyle(runningBalance)}</td>
        </tr>`;

        let lastInvoiceNumber = null;

        transactions.forEach(tx => {
            if (tx.type === 'invoice_item') {
                const displayDate = tx.invoiceNumber !== lastInvoiceNumber ? tx.date : '';
                const displayInvoiceNumber = tx.invoiceNumber !== lastInvoiceNumber ? tx.invoiceNumber : '';

                runningBalance += tx.amount;
                totalDebit += tx.amount;

                ledgerHTML += `<tr>
                    <td class="text-center">${displayDate}</td>
                    <td class="text-center">${displayInvoiceNumber}</td>
                    <td class="product-name-col">${tx.productName}</td>
                    <td class="text-center">${tx.qty}</td>
                    <td class="text-center">${tx.packing || ''}</td>
                    <td class="text-right">${formatNumberInIndianStyle(tx.unitPrice)}</td>
                    <td class="text-right">${formatNumberInIndianStyle(tx.amount)}</td>
                    <td></td>
                    <td class="text-right">${formatNumberInIndianStyle(runningBalance)}</td>
                </tr>`;
                lastInvoiceNumber = tx.invoiceNumber;
            } else if (tx.type === 'payment') {
                runningBalance -= tx.amount;
                totalCredit += tx.amount;
                let paymentDesc = `Payment Received`;
                if (tx.remarks) {
                    paymentDesc += ` (${tx.remarks})`;
                }
                ledgerHTML += `<tr class="payment-row">
                    <td class="text-center">${tx.date}</td>
                    <td></td>
                    <td colspan="5">${paymentDesc}</td>
                    <td class="text-right">${formatNumberInIndianStyle(tx.amount)}</td>
                    <td class="text-right">${formatNumberInIndianStyle(runningBalance)}</td>
                </tr>`;
                lastInvoiceNumber = null;
            }
        });

        ledgerHTML += `</tbody>
        <tfoot>
            <tr class="total-row">
                <td colspan="6" class="text-right"><strong>Totals</strong></td>
                <td class="text-right"><strong>${formatNumberInIndianStyle(totalDebit)}</strong></td>
                <td class="text-right"><strong>${formatNumberInIndianStyle(totalCredit)}</strong></td>
                <td></td>
            </tr>
            <tr class="total-row">
                <td colspan="8" class="text-right"><strong>Remaining Balance</strong></td>
                <td class="text-right"><strong>${formatNumberInIndianStyle(ledgerData.currentBalance)}</strong></td>
            </tr>
        </tfoot>
        </table>`;

        ledgerDisplayArea.innerHTML = ledgerHTML;
        currentLedgerDataForPDF = ledgerData;
        downloadLedgerPdfBtn.style.display = 'inline-block';
        hideLoadingStatus(`${partyName} ka ledger dikha diya gaya.`, false);

    } catch (error) {
        ledgerDisplayArea.innerHTML = `<p style="color: red;">Error: ${error.message || 'Ledger fetch nahi ho saka.'}</p>`;
        downloadLedgerPdfBtn.style.display = 'none';
        currentLedgerDataForPDF = null;
        hideLoadingStatus(error, true);
    }
}

// --- MODIFIED: downloadLedgerPDF to show Debit/Credit totals and remaining balance ---
/**
 * Generates and downloads a PDF of the party's detailed ledger.
 * Iterates through the sorted transactions to build the table.
 */
// Updated downloadLedgerPDF function with Debit/Credit totals
function downloadLedgerPDF() {
    if (!currentLedgerDataForPDF || !currentLedgerDataForPDF.partyName) {
        alert("Barae meharbani pehle 'Ledger Dekhain' per click karke ledger display karen.");
        return;
    }

    const { partyName, transactions, openingBalance = 0, currentBalance = 0, totalDebit = 0, totalCredit = 0 } = currentLedgerDataForPDF;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
    const margin = 12;
    const pageWidth = doc.internal.pageSize.getWidth();
    let currentY = 32;

    const didDrawPage = (data) => {
        addPdfHeaderAndFooter(doc, { showSignatures: true }, `Party Statement`);
    };

    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(...PDF_PRIMARY_COLOR);
    doc.text(partyName, pageWidth / 2, currentY, { align: 'center' });
    currentY += 8;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    const transactionDates = transactions.map(tx => new Date(tx.date)).filter(date => !isNaN(date.getTime()));
    const startDate = transactionDates.length > 0 ? new Date(Math.min(...transactionDates)).toISOString().slice(0, 10) : 'N/A';
    const endDate = transactionDates.length > 0 ? new Date(Math.max(...transactionDates)).toISOString().slice(0, 10) : 'N/A';

    doc.text(`Statement Period: ${startDate} to ${endDate}`, pageWidth / 2, currentY, { align: 'center' });
    currentY += 12;

    const head = [['Date', 'Invoice #', 'Product Name / Description', 'Qty', 'Packing', 'Unit Price', 'Debit', 'Credit', 'Balance']];
    let runningBalanceForPdf = openingBalance;

    const body = [];

    // Opening Balance Row with Indian formatting
    body.push([
        { content: 'Previous Balance', colSpan: 8, styles: { halign: 'right', fontStyle: 'bold' } },
        { content: formatNumberInIndianStyle(openingBalance), styles: { halign: 'right', fontStyle: 'bold' } }
    ]);

    let lastInvoiceNumber = null;

    // Calculate running totals for PDF
    let pdfTotalDebit = 0;
    let pdfTotalCredit = 0;

    transactions.forEach(tx => {
        if (tx.type === 'invoice_item') {
            const displayDate = tx.invoiceNumber !== lastInvoiceNumber ? tx.date : '';
            const displayInvoiceNumber = tx.invoiceNumber !== lastInvoiceNumber ? tx.invoiceNumber : '';

            runningBalanceForPdf += tx.amount;
            pdfTotalDebit += tx.amount; // Add to PDF debit total

            body.push([
                displayDate,
                displayInvoiceNumber,
                tx.productName,
                tx.qty,
                tx.packing || '',
                { content: formatNumberInIndianStyle(tx.unitPrice), styles: { halign: 'right' } },
                { content: formatNumberInIndianStyle(tx.amount), styles: { halign: 'right' } },
                '',
                { content: formatNumberInIndianStyle(runningBalanceForPdf), styles: { halign: 'right' } }
            ]);
            lastInvoiceNumber = tx.invoiceNumber;
        } else if (tx.type === 'payment') {
            runningBalanceForPdf -= tx.amount;
            pdfTotalCredit += tx.amount; // Add to PDF credit total
            let paymentDesc = `Payment Received`;
            if (tx.remarks) {
                paymentDesc += ` (${tx.remarks})`;
            }
            body.push([
                tx.date,
                '',
                { content: paymentDesc, colSpan: 5, styles: { fontStyle: 'bold', textColor: [200, 0, 0], halign: 'left' } },
                { content: formatNumberInIndianStyle(tx.amount), styles: { halign: 'right' } },
                { content: formatNumberInIndianStyle(runningBalanceForPdf), styles: { halign: 'right', fontStyle: 'bold' } }
            ]);
            lastInvoiceNumber = null;
        }
    });

    // Totals Row with Indian formatting - DEBIT/CREDIT TOTALS ADDED HERE
    body.push([
        { content: 'Totals', colSpan: 6, styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
        { content: formatNumberInIndianStyle(pdfTotalDebit), styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
        { content: formatNumberInIndianStyle(pdfTotalCredit), styles: { halign: 'right', fontStyle: 'bold', fillColor: [240, 240, 240] } },
        { content: '', styles: { fillColor: [240, 240, 240] } } // Empty cell for balance
    ]);

    // Final Balance row with Indian formatting
    body.push([
        { content: 'Remaining Balance', colSpan: 8, styles: { halign: 'right', fontStyle: 'bold', fillColor: '#e6ffed', textColor: [10, 90, 40] } },
        { content: formatNumberInIndianStyle(currentBalance), styles: { halign: 'right', fontStyle: 'bold', fillColor: '#e6ffed', textColor: [10, 90, 40] } }
    ]);

    doc.autoTable({
        head: head,
        body: body,
        startY: currentY,
        theme: 'grid',
        headStyles: { fillColor: PDF_PRIMARY_COLOR, fontSize: 9.5 },
        columnStyles: {
            0: { cellWidth: 22, halign: 'center' },
            1: { cellWidth: 13, halign: 'center' },
            2: { cellWidth: 38 },
            3: { cellWidth: 12, halign: 'center' },
            4: { cellWidth: 12, halign: 'center' },
            5: { cellWidth: 20, halign: 'right' },
            6: { cellWidth: 24, halign: 'right' },
            7: { cellWidth: 24, halign: 'right' },
            8: { cellWidth: 25, halign: 'right' }
        },
        didDrawPage: didDrawPage,
        margin: { top: 35, bottom: 50 },
        styles: { fontSize: 9, cellPadding: 2 }
    });

    // Additional summary below the table
    currentY = doc.autoTable.previous.finalY + 15;

    if (currentY > doc.internal.pageSize.getHeight() - 50) {
        doc.addPage();
        currentY = 35;
        didDrawPage({ pageNumber: doc.internal.getCurrentPageInfo().pageNumber });
    }

    // Add a summary section
    doc.setFontSize(11);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(...PDF_PRIMARY_COLOR);
    doc.text("Transaction Summary:", margin, currentY);
    currentY += 8;

    doc.setFont("helvetica", "normal");
    doc.setTextColor(...PDF_TEXT_COLOR);

    const summaryLeft = margin;
    const summaryRight = pageWidth - margin - 60;

    // Total Debit
    doc.text("Total Debit (Sales):", summaryLeft, currentY);
    doc.text(formatNumberInIndianStyle(pdfTotalDebit), summaryRight, currentY, { align: 'right' });
    currentY += 6;

    // Total Credit
    doc.text("Total Credit (Payments):", summaryLeft, currentY);
    doc.text(formatNumberInIndianStyle(pdfTotalCredit), summaryRight, currentY, { align: 'right' });
    currentY += 6;

    // Net Balance Change
    const netChange = pdfTotalDebit - pdfTotalCredit;
    doc.text("Net Balance Change:", summaryLeft, currentY);
    doc.text(formatNumberInIndianStyle(netChange), summaryRight, currentY, { align: 'right' });
    currentY += 6;

    // Opening Balance
    doc.text("Opening Balance:", summaryLeft, currentY);
    doc.text(formatNumberInIndianStyle(openingBalance), summaryRight, currentY, { align: 'right' });
    currentY += 6;

    // Closing Balance
    doc.setFont("helvetica", "bold");
    doc.setTextColor(...PDF_PRIMARY_COLOR);
    doc.text("Closing Balance:", summaryLeft, currentY);
    doc.text(formatNumberInIndianStyle(currentBalance), summaryRight, currentY, { align: 'right' });
    currentY += 10;

    // Add a horizontal line
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.3);
    doc.line(margin, currentY, pageWidth - margin, currentY);

    doc.save(`PartyStatement_Detailed_${partyName.replace(/\s+/g, '_')}.pdf`);
    hideLoadingStatus("Detailed Party Statement PDF download ho gaya.", false);
}

const getPdfTableStyles = (themeColor = PDF_PRIMARY_COLOR, fontSize = 9, headFontSize = 9.5) => ({
    theme: 'striped',
    headStyles: { fillColor: themeColor, textColor: [255,255,255], fontStyle: 'bold', fontSize: headFontSize, halign: 'center', valign: 'middle', cellPadding: 3, lineWidth: 0.1, lineColor: [200,200,200] },
    bodyStyles: { fontSize: fontSize, cellPadding: 2.5, valign: 'middle', textColor: PDF_TEXT_COLOR, lineWidth: 0.1, lineColor: [220,220,220] },
    alternateRowStyles: { fillColor: PDF_TABLE_ALT_ROW_BG },
    footStyles: { fillColor: [230,230,230], textColor: PDF_TEXT_COLOR, fontStyle: 'bold', fontSize: fontSize, halign: 'right', cellPadding: 2.5, lineWidth: 0.1, lineColor: [200,200,200] },
    styles: { lineWidth: 0.15, lineColor: [180,180,180], valign: 'middle', cellBorder: 'grid', },
    margin: { top: 48, bottom: 40, left: 12, right: 12 },
    tableWidth: 'auto',
    showHead: 'everyPage',
    showFoot: 'lastPage',
});

        function downloadCurrentInvoicePDF() {
            const partyName = partyInput.value.trim();
            if (!partyName) {
                alert("Party name required.");
                return;
            }
            const items = [];
            let formIsValid = true;
            rowsContainer.querySelectorAll('tr').forEach(row => {
                const productName = row.querySelector('.product-name').value.trim();
                const qty = parseFloat(row.querySelector('.qty').value);
                const packing = row.querySelector('.packing').value;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value);
                if (productName && (isNaN(qty) || qty <= 0 || isNaN(unitPrice) || unitPrice < 0)) {
                    alert('Please fill all item rows completely or remove unused rows.');
                    formIsValid = false;
                    return;
                }
                if (productName) items.push({
                    productName,
                    qty,
                    packing,
                    unitPrice,
                    amount: qty * unitPrice
                });
            });
            if (!formIsValid || items.length === 0) {
                alert("Please add valid items to the invoice before downloading.");
                return;
            }
            const invoiceData = {
                partyName,
                date: dateInput.value,
                invoiceNumber: invoiceNumberInput.value,
                items,
                totalAmount: parseFloat(totalAmountSpan.textContent),
                previousBalance: parseFloat(prevBalanceInput.value),
                grandTotal: parseFloat(grandTotalSpan.textContent)
            };
            const doc = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: 'a4'
            });
            let currentY = 48;
            addPdfHeaderAndFooter(doc, {
                addHeaderOnEveryPage: true,
                addWatermarkOnEveryPage: true,
                showSignatures: true
            }, " Invoice");
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);
            doc.text("Bill To:", 12, currentY);
            doc.setFont("helvetica", "normal");
            doc.text(invoiceData.partyName, 12 + 22, currentY, {maxWidth: doc.internal.pageSize.getWidth() / 2 - 12 - 25});
            doc.setFont("helvetica", "bold");
            doc.text("Invoice #:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
            doc.setFont("helvetica", "normal");
            doc.text(invoiceData.invoiceNumber.toString(), doc.internal.pageSize.getWidth() / 2 + 40, currentY);
            currentY += 7;
            doc.setFont("helvetica", "bold");
            doc.text("Date:", doc.internal.pageSize.getWidth() / 2 + 15, currentY);
            doc.setFont("helvetica", "normal");
            doc.text(invoiceData.date, doc.internal.pageSize.getWidth() / 2 + 40, currentY);
            currentY += 12;
            const head = [['Sr.', 'Product Name', 'Qty', 'Packing', 'Unit Price', 'Amount']];
            const body = invoiceData.items.map((item, index) => [
                index + 1,
                item.productName,
                item.qty,
                item.packing,
                item.unitPrice.toFixed(2),
                item.amount.toFixed(2)
            ]);
            doc.autoTable({
                head,
                body,
                startY: currentY, ...getPdfTableStyles(),
                columnStyles: {
                    0: { halign: 'center', cellWidth: 12 },
                    1: { halign: 'left', cellWidth: 70 },
                    2: { halign: 'center', cellWidth: 18 },
                    3: { halign: 'center', cellWidth: 22 },
                    4: { halign: 'right', cellWidth: 28 },
                    5: { halign: 'right', cellWidth: 30 }
                },
                didDrawPage: (data) => {
                    addPdfHeaderAndFooter(doc, data, " Invoice", true);
                    currentY = 48;
                }
            });
            currentY = doc.autoTable.previous.finalY + 10;
            const totalsX = doc.internal.pageSize.getWidth() - 12 - 65;
            const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Subtotal:", totalsX, currentY, {
                align: 'right'
            });
            doc.text(invoiceData.totalAmount.toFixed(2), amountsX, currentY, {
                align: 'right'
            });
            currentY += 7;
            doc.text("Previous Balance:", totalsX, currentY, {
                align: 'right'
            });
            doc.text(invoiceData.previousBalance.toFixed(2), amountsX, currentY, {
                align: 'right'
            });
            currentY += 7;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
            doc.text("Grand Total:", totalsX, currentY, {
                align: 'right'
            });
            doc.text(invoiceData.grandTotal.toFixed(2), amountsX, currentY, {
                align: 'right'
            });
            doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);
            currentY += 12;
            if (currentY > doc.internal.pageSize.getHeight() - 12 - 50) {
                doc.addPage();
                currentY = 48;
                addPdfHeaderAndFooter(doc, {pageNumber: doc.internal.getCurrentPageInfo().pageNumber}, "Tax Invoice", true);
            }
            doc.setFontSize(8);
            doc.setFont("helvetica", "bolditalic");
            doc.text("Terms & Conditions:", 12, currentY);
            currentY += 4.5;
            doc.setFont("helvetica", "italic");
            doc.text("1. Goods once sold will not be taken back or exchanged.", 12, currentY, {maxWidth: doc.internal.pageSize.getWidth() - 24});
            currentY += 4;
            doc.text("2. All disputes subject to Multan jurisdiction.", 12, currentY, {maxWidth: doc.internal.pageSize.getWidth() - 24});
            doc.save(`Invoice_${invoiceData.invoiceNumber}_${invoiceData.partyName.replace(/\s+/g, '_')}.pdf`);
            hideLoadingStatus("Current invoice PDF downloaded.", false);
        }
function downloadLastPaymentReceiptPDF() {
    if (!lastPaymentDetails) {
        alert("No payment has been recorded in this session to generate a receipt.");
        return;
    }

    const { partyName, amount, date, remarks, paymentId } = lastPaymentDetails;
    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a5' });
    const margin = 10;
    let currentY = 38;

    addPdfHeaderAndFooter(doc, {
        addHeaderOnEveryPage: false,
        addWatermarkOnEveryPage: true,
        showSignatures: false
    }, "Payment Receipt");

    doc.setFontSize(15);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
    doc.text("Payment Receipt", doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
    currentY += 12;

    doc.setDrawColor(PDF_MUTED_TEXT_COLOR[0], PDF_MUTED_TEXT_COLOR[1], PDF_MUTED_TEXT_COLOR[2]);
    doc.setLineWidth(0.25);
    doc.line(margin, currentY, doc.internal.pageSize.getWidth() - margin, currentY);
    currentY += 10;

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);

    const fieldLabelX = margin;
    const fieldValueX = margin + 35;

    const addReceiptLine = (label, value, isBoldValue = false) => {
        doc.setFont("helvetica", "bold");
        doc.text(label, fieldLabelX, currentY);
        doc.setFont("helvetica", isBoldValue ? "bold" : "normal");
        doc.text(value, fieldValueX, currentY, {maxWidth: doc.internal.pageSize.getWidth() - fieldValueX - margin});
        currentY += 7;
    };

    addReceiptLine("Receipt No:", (paymentId || "N/A").toString());
    addReceiptLine("Date:", date);
    addReceiptLine("Received From:", partyName);

    if (remarks) {
        addReceiptLine("Remarks:", remarks);
    }

    currentY += 3;
    addReceiptLine("Amount (PKR):", formatNumberInIndianStyle(amount), true); // Indian format
    currentY += 2;
    addReceiptLine("Amount in Words:", convertToWords(amount) + " Rupees Only");
    currentY += 10;

    doc.line(margin, currentY, doc.internal.pageSize.getWidth() - margin, currentY);
    currentY += 10;

    doc.setFontSize(8);
    doc.setFont("helvetica", "italic");
    doc.setTextColor(PDF_MUTED_TEXT_COLOR[0], PDF_MUTED_TEXT_COLOR[1], PDF_MUTED_TEXT_COLOR[2]);
    doc.text("This is a computer-generated receipt.", doc.internal.pageSize.getWidth() / 2, currentY, {align: 'center'});
    currentY += 8;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
    doc.text("Thank you for your payment!", doc.internal.pageSize.getWidth() / 2, currentY, {align: 'center'});

    doc.save(`PaymentReceipt_${paymentId}_${partyName.replace(/\s+/g, '_')}.pdf`);
    hideLoadingStatus("Payment receipt PDF downloaded.", false);
    downloadPaymentReceiptBtn.style.display = 'none';
    lastPaymentDetails = null;
}
        async function downloadPaymentsByDateRange() {
    const startDate = paymentStartDateInput.value;
    const endDate = paymentEndDateInput.value;

    if (!startDate || !endDate) {
        alert("Barae meharbani payments download karne ke liye start aur end date select karen.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date end date se pehle honi chahiye.");
        return;
    }

    showLoadingStatus(`Payments fetch ho rahe hain ${startDate} se ${endDate} tak...`);

    try {
        const response = await fetch(`${API_BASE_URL}/api/payments?startDate=${startDate}&endDate=${endDate}`);
        if (!response.ok) await handleFetchError(response, "Specified range ke liye payments fetch karne me nakami.");
        let payments = await response.json();

        if (!payments || payments.length === 0) {
            alert(`Specified date range (${startDate} to ${endDate}) ke liye koi payments nahi mile.`);
            hideLoadingStatus("Specified range ke liye koi payments nahi mile.", true);
            return;
        }

        payments = sortPayments(payments);
        hideLoadingStatus(`Generating Payments Report PDF for ${startDate} to ${endDate}...`, false);

        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        let currentY = 48;
        let totalPaymentsAmount = 0;

        const pdfTitle = `Payments Report (${startDate} to ${endDate})`;

        const commonPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 15;

        const head = [['Sr.', 'Date', 'Party Name', 'Remarks', 'Amount (PKR)']];
        const body = payments.map((pay, index) => {
            totalPaymentsAmount += parseFloat(pay.amount);
            return [
                index + 1,
                pay.date,
                pay.partyName,
                pay.remarks || '',
                formatNumberInIndianStyle(pay.amount) // Indian format
            ];
        });

        doc.autoTable({
            head,
            body,
            startY: currentY,
            ...getPdfTableStyles(PDF_TERTIARY_COLOR),
            columnStyles: {
                0: {cellWidth:12, halign:'center'},
                1: {halign:'center', cellWidth:25},
                2: {halign:'left'},
                3: {halign:'left'},
                4: {halign:'right', cellWidth:30}
            },
            didDrawPage: commonPageHook
        });

        currentY = doc.autoTable.previous.finalY + 12;

        if (currentY + 15 > doc.internal.pageSize.getHeight() - 40) {
            doc.addPage();
            addPdfHeaderAndFooter(doc, {pageNumber: doc.internal.getCurrentPageInfo().pageNumber}, pdfTitle, true);
            currentY = 48;
        }

        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setDrawColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setLineWidth(0.5);

        const totalLabel = "Total Amount for this Period:";
        const totalAmountStr = formatNumberInIndianStyle(totalPaymentsAmount); // Indian format
        const totalLabelWidth = doc.getTextWidth(totalLabel);
        const totalAmountWidth = doc.getTextWidth(totalAmountStr);
        const totalStartX = doc.internal.pageSize.getWidth() - 12 - totalAmountWidth - totalLabelWidth - 5;

        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
        currentY += 8;
        doc.text(totalLabel, totalStartX, currentY);
        doc.text(totalAmountStr, doc.internal.pageSize.getWidth() - 12 - totalAmountWidth, currentY);
        currentY += 8;
        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);

        doc.save(`Payments_Report_${startDate}_to_${endDate}.pdf`);
        hideLoadingStatus("Payments Report PDF generated.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}
async function downloadInvoicesByDateRange() {
    const startDate = invoiceStartDateInput.value;
    const endDate = invoiceEndDateInput.value;

    if (!startDate || !endDate) {
        alert("Barae meharbani invoices download karne ke liye start aur end date select karen.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date end date se pehle honi chahiye.");
        return;
    }

    showLoadingStatus(`Invoices fetch ho رہے ہیں ${startDate} سے ${endDate} تک...`);

    try {
        const response = await fetch(`${API_BASE_URL}/api/invoices?startDate=${startDate}&endDate=${endDate}`);
        if (!response.ok) await handleFetchError(response, "Specified range کے لیے invoices fetch کرنے میں ناکامی۔");
        let invoices = await response.json();

        if (!invoices || invoices.length === 0) {
            alert(`Specified date range (${startDate} to ${endDate}) کے لیے کوئی invoices نہیں ملے۔`);
            hideLoadingStatus("Specified range کے لیے کوئی invoices نہیں ملے۔", true);
            return;
        }

        invoices = sortInvoices(invoices);
        hideLoadingStatus(`Generating Invoices Report PDF for ${startDate} to ${endDate}...`, false);

        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        let currentY = 48;
        let overallSubtotalSum = 0;

        const pdfTitle = `Invoices Report (${startDate} to ${endDate})`;

        const commonPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 15;

        for (let i = 0; i < invoices.length; i++) {
            const inv = invoices[i];
            overallSubtotalSum += parseFloat(inv.totalAmount);
            const estHeight = inv.items.length * 7 + 55;

            if (currentY + estHeight > doc.internal.pageSize.getHeight() - 50 && i > 0) {
                doc.addPage();
                addPdfHeaderAndFooter(doc, { pageNumber: doc.internal.getCurrentPageInfo().pageNumber }, pdfTitle, true);
                currentY = 48;
            } else if (i > 0) {
                doc.setDrawColor(180, 180, 180);
                doc.setLineWidth(0.3);
                doc.line(12, currentY - 5, doc.internal.pageSize.getWidth() - 12, currentY - 5);
                currentY += 3;
            }

            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);
            doc.text(`Invoice #: ${inv.invoiceNumber}`, 12, currentY);
            doc.setFont("helvetica", "normal");
            doc.text(`Party: ${inv.partyName}`, 12 + 45, currentY, { maxWidth: doc.internal.pageSize.getWidth() - 12 - 100 });

            const dateText = `Date: ${inv.date}`;
            const dateWidth = doc.getTextWidth(dateText);
            doc.text(dateText, doc.internal.pageSize.getWidth() - 12 - dateWidth, currentY);
            currentY += 8;

            const head = [['Sr.', 'Product', 'Qty', 'Packing', 'Price', 'Amount']];
            const body = inv.items.map((item, index) => [
                index + 1,
                item.productName,
                item.qty,
                item.packing,
                formatNumberInIndianStyle(item.unitPrice), // Indian format
                formatNumberInIndianStyle(item.amount)     // Indian format
            ]);

            doc.autoTable({
                head,
                body,
                startY: currentY,
                ...getPdfTableStyles(PDF_PRIMARY_COLOR, 8, 9),
                columnStyles: {
                    0: { cellWidth: 10 },
                    1: { cellWidth: 60 },
                    4: { halign: 'right' },
                    5: { halign: 'right' }
                },
                didDrawPage: commonPageHook
            });

            currentY = doc.autoTable.previous.finalY + 7;

            const totalsX = doc.internal.pageSize.getWidth() - 12 - 60;
            const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;

            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text("Subtotal:", totalsX, currentY, { align: 'right' });
            doc.text(formatNumberInIndianStyle(inv.totalAmount), amountsX, currentY, { align: 'right' }); // Indian format

            currentY += 6;
            doc.text("Prev. Balance:", totalsX, currentY, { align: 'right' });
            doc.text(formatNumberInIndianStyle(inv.previousBalance), amountsX, currentY, { align: 'right' }); // Indian format

            currentY += 6;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text("Grand Total:", totalsX, currentY, { align: 'right' });
            doc.text(formatNumberInIndianStyle(inv.grandTotal), amountsX, currentY, { align: 'right' }); // Indian format

            currentY += 10;
        }

        if (currentY + 20 > doc.internal.pageSize.getHeight() - 50) {
            doc.addPage();
            commonPageHook({ pageNumber: doc.internal.getCurrentPageInfo().pageNumber });
        }

        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setDrawColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setLineWidth(0.5);

        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
        currentY += 8;

        doc.text("Total of Invoices in this Period (Subtotals):", doc.internal.pageSize.getWidth() - 12 - 120, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(overallSubtotalSum), doc.internal.pageSize.getWidth() - 12 - 15, currentY, { align: 'right' }); // Indian format

        currentY += 8;
        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);

        doc.save(`Invoices_Report_${startDate}_to_${endDate}.pdf`);
        hideLoadingStatus("Invoices Report PDF generated.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}
async function downloadAllPartyLedgersPDF() {
    showLoadingStatus("Fetching all party data for balances summary...");

    try {
        const response = await fetch(`${API_BASE_URL}/api/all-party-ledgers`);
        if (!response.ok) await handleFetchError(response, "Failed to fetch all party data.");
        let allLedgersData = await response.json();

        if (!allLedgersData || allLedgersData.length === 0) {
            alert("No party data found to generate a report.");
            hideLoadingStatus("No party data available.", true);
            return;
        }

        // Filter out parties with zero balance
        const nonZeroBalanceParties = allLedgersData.filter(ledger => {
            const balance = parseFloat(ledger.currentBalance) || 0;
            return balance !== 0;
        });

        if (nonZeroBalanceParties.length === 0) {
            alert("No parties with non-zero balance found to generate a report.");
            hideLoadingStatus("No non-zero balance parties available.", true);
            return;
        }

        // Fetch last payment details for non-zero balance parties only
        showLoadingStatus("Fetching last payment details for parties with non-zero balances...");
        const lastPaymentDetails = await fetchLastPaymentDetailsForParties(nonZeroBalanceParties);

        nonZeroBalanceParties.sort((a, b) => a.partyName.localeCompare(b.partyName));
        hideLoadingStatus("Generating All Party Balances PDF...", false);

        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        let currentY = 48;
        const pdfTitle = "All Party Balances Summary";

        addPdfHeaderAndFooter(doc, {
            pageNumber: 1,
            addHeaderOnEveryPage: true,
            addWatermarkOnEveryPage: true,
            showSignatures: false
        }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 15;

        // Add summary of filtering
        doc.setFontSize(10);
        doc.setFont("helvetica", "italic");
        doc.setTextColor(100, 100, 100);
        doc.text(`Showing ${nonZeroBalanceParties.length} of ${allLedgersData.length} parties (non-zero balances only)`,
                doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 8;

        // Updated table headers with actual payment remarks
        const head = [['Sr.', 'Party Name', 'Current Balance (PKR)', 'Last Payment Remarks']];
        const body = [];
        let overallTotalCorrectedBalance = 0;

        for (let i = 0; i < nonZeroBalanceParties.length; i++) {
            const ledger = nonZeroBalanceParties[i];
            const correctedBalance = parseFloat(ledger.currentBalance) || 0;
            overallTotalCorrectedBalance += correctedBalance;

            // Get last payment details for this party
            const partyName = ledger.partyName;
            const paymentDetails = lastPaymentDetails[partyName] || {
                date: 'No record',
                amount: 0,
                remarks: 'No payment record',
                status: 'No payments'
            };

            body.push([
                i + 1,
                partyName,
                formatNumberInIndianStyle(correctedBalance),
                paymentDetails.remarks || 'No remarks' // Show actual remarks from payment
            ]);
        }

        doc.autoTable({
            head,
            body,
            startY: currentY,
            ...getPdfTableStyles(PDF_SECONDARY_COLOR),
            columnStyles: {
                0: { halign: 'center', cellWidth: 12 },
                1: { halign: 'left', cellWidth: 70 },
                2: { halign: 'right', cellWidth: 45 },
                3: { halign: 'left', cellWidth: 63 }
            },
            didDrawPage: (data) => {
                addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
                currentY = 48;
            }
        });

        currentY = doc.autoTable.previous.finalY + 12;

        if (currentY + 15 > doc.internal.pageSize.getHeight() - 40) {
            doc.addPage();
            addPdfHeaderAndFooter(doc, {pageNumber: doc.internal.getCurrentPageInfo().pageNumber}, pdfTitle, true);
            currentY = 48;
        }

        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setDrawColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.setLineWidth(0.5);

        const totalLabel = "Total:";
        const totalAmountStr = formatNumberInIndianStyle(overallTotalCorrectedBalance);
        const totalLabelWidth = doc.getTextWidth(totalLabel);
        const totalAmountWidth = doc.getTextWidth(totalAmountStr);
        const totalStartX = doc.internal.pageSize.getWidth() - 12 - totalAmountWidth - totalLabelWidth - 5;

        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
        currentY += 8;
        doc.text(totalLabel, totalStartX, currentY);
        doc.text(totalAmountStr, doc.internal.pageSize.getWidth() - 12 - totalAmountWidth, currentY);
        currentY += 8;
        doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);

        doc.save('All_Party_Non_Zero_Balances_Summary.pdf');
        hideLoadingStatus("All Party Non-Zero Balances PDF generated.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}

async function fetchLastPaymentDetailsForParties(parties) {
    const lastPaymentDetails = {};

    try {
        // Fetch all payments
        const response = await fetch(`${API_BASE_URL}/api/payments`);
        if (!response.ok) {
            console.warn("Could not fetch payments for last payment details");
            // Initialize with default values
            parties.forEach(party => {
                lastPaymentDetails[party.partyName] = {
                    date: 'No record',
                    amount: 0,
                    remarks: 'No payment record',
                    status: 'No payments'
                };
            });
            return lastPaymentDetails;
        }

        const allPayments = await response.json();

        // Group payments by party and find latest date for each
        parties.forEach(party => {
            const partyPayments = allPayments.filter(payment =>
                payment.partyName && payment.partyName.toLowerCase() === party.partyName.toLowerCase()
            );

            if (partyPayments.length > 0) {
                // Sort payments by date descending and get the latest one
                partyPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                const latestPayment = partyPayments[0];

                // Format date
                const formattedDate = formatDateToDDMMYYYY(latestPayment.date);
                const paymentAmount = parseFloat(latestPayment.amount) || 0;

                // Determine payment status based on how recent it was
                const paymentStatus = getPaymentStatus(latestPayment.date);

                // Use ACTUAL REMARKS from payment record
                let remarks = '';
                if (latestPayment.remarks && latestPayment.remarks.trim() !== '') {
                    // Use the actual remarks entered by user
                    remarks = latestPayment.remarks.trim();
                } else {
                    // If no remarks, show basic info
                    remarks = `Payment: ${formatNumberInIndianStyle(paymentAmount)} - ${formattedDate}`;
                }

                lastPaymentDetails[party.partyName] = {
                    date: formattedDate,
                    amount: paymentAmount,
                    remarks: remarks,
                    status: paymentStatus
                };
            } else {
                lastPaymentDetails[party.partyName] = {
                    date: 'No record',
                    amount: 0,
                    remarks: 'No payment record',
                    status: 'No payments'
                };
            }
        });

    } catch (error) {
        console.error("Error fetching last payment details:", error);
        // If there's an error, set all to default values
        parties.forEach(party => {
            lastPaymentDetails[party.partyName] = {
                date: 'No record',
                amount: 0,
                remarks: 'Error fetching payment data',
                status: 'Error'
            };
        });
    }

    return lastPaymentDetails;
}

// Helper function to format date to DD-MM-YYYY
function formatDateToDDMMYYYY(dateString) {
    if (!dateString || dateString === 'No record') return 'No record';

    try {
        // Handle different date formats
        let date;
        if (typeof dateString === 'string') {
            if (dateString.includes('-')) {
                // Already in DD-MM-YYYY or similar format
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    // Try to parse as DD-MM-YYYY
                    if (parts[0].length === 2 && parts[1].length === 2) {
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    } else if (parts[0].length === 4) {
                        // YYYY-MM-DD format
                        date = new Date(dateString);
                    } else {
                        date = new Date(dateString);
                    }
                } else {
                    date = new Date(dateString);
                }
            } else if (dateString.includes('/')) {
                // Handle DD/MM/YYYY format
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    date = new Date(dateString);
                }
            } else {
                // Try standard date parsing
                date = new Date(dateString);
            }
        } else if (dateString instanceof Date) {
            date = dateString;
        } else {
            console.warn("Unknown date format:", dateString);
            return 'Invalid date';
        }

        if (isNaN(date.getTime())) {
            console.warn(`Invalid date format: ${dateString}`);
            return 'Invalid date';
        }

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();

        return `${day}-${month}-${year}`;
    } catch (error) {
        console.error("Error formatting date:", error, "Date string:", dateString);
        return 'Invalid date';
    }
}

// Helper function to determine payment status based on recency
function getPaymentStatus(lastPaymentDate) {
    if (!lastPaymentDate || lastPaymentDate === 'No record' || lastPaymentDate === 'Invalid date') {
        return 'No payments';
    }

    try {
        const dateParts = lastPaymentDate.split('-');
        if (dateParts.length !== 3) return 'Unknown';

        const paymentDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
        const today = new Date();
        const diffTime = Math.abs(today - paymentDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 30) return 'Recent (≤30 days)';
        if (diffDays <= 90) return 'Moderate (≤90 days)';
        return 'Old (>90 days)';
    } catch (error) {
        console.error("Error calculating payment status:", error);
        return 'Unknown';
    }
}

        async function downloadAllPaymentsPDFWithTotal() {
            showLoadingStatus("Fetching all payments...");
            try {
                const response = await fetch(`${API_BASE_URL}/api/payments`);
                if (!response.ok) await handleFetchError(response, "Failed to fetch all payments.");
                let payments = await response.json();
                if (!payments || payments.length === 0) {
                    alert("No payments found to generate a report.");
                    hideLoadingStatus("No payments found.", true);
                    return;
                }
                payments = sortPayments(payments);
                hideLoadingStatus("Generating All Payments PDF...", false);
                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });
                let currentY = 48;
                let totalPaymentsAmount = 0;
                const commonPageHook = (data) => {
                    addPdfHeaderAndFooter(doc, data, "All Payments Report", data.pageNumber > 1);
                    currentY = 48;
                };
                addPdfHeaderAndFooter(doc, {
                    pageNumber: 1
                }, "All Payments Report");
                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
                doc.text("All Recorded Payments", doc.internal.pageSize.getWidth() / 2, currentY, {
                    align: 'center'
                });
                currentY += 15;
                const head = [['Sr.', 'Date', 'Party Name', 'Remarks', 'Amount (PKR)']];
                const body = payments.map((pay, index) => {
                    totalPaymentsAmount += parseFloat(pay.amount);
                    return [
                        index + 1,
                        pay.date,
                        pay.partyName,
                        pay.remarks || '',
                        parseFloat(pay.amount).toFixed(2)
                    ];
                });
                doc.autoTable({
                    head,
                    body,
                    startY: currentY,
                    ...getPdfTableStyles(PDF_TERTIARY_COLOR),
                    columnStyles: {
                        0: {cellWidth:12, halign:'center'},
                        1: {halign:'center', cellWidth:25},
                        2: {halign:'left'},
                        3: {halign:'left'},
                        4: {halign:'right', cellWidth:30}
                    },
                    didDrawPage: commonPageHook
                });
                currentY = doc.autoTable.previous.finalY + 12;
                if (currentY + 15 > doc.internal.pageSize.getHeight() - 40) {
                    doc.addPage();
                    addPdfHeaderAndFooter(doc, {pageNumber: doc.internal.getCurrentPageInfo().pageNumber}, "All Payments Report", true);
                    currentY = 48;
                }
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
                doc.setDrawColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
                doc.setLineWidth(0.5);
                const totalLabel = "Total Amount of All Payments:";
                const totalAmountStr = totalPaymentsAmount.toFixed(2);
                const totalLabelWidth = doc.getTextWidth(totalLabel);
                const totalAmountWidth = doc.getTextWidth(totalAmountStr);
                const totalStartX = doc.internal.pageSize.getWidth() - 12 - totalAmountWidth - totalLabelWidth - 5;
                doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
                currentY += 8;
                doc.text(totalLabel, totalStartX, currentY);
                doc.text(totalAmountStr, doc.internal.pageSize.getWidth() - 12 - totalAmountWidth, currentY);
                currentY += 8;
                doc.line(12, currentY, doc.internal.pageSize.getWidth() - 12, currentY);
                doc.save('All_Payments_Report.pdf');
                hideLoadingStatus("All payments PDF generated.", false);
            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }
async function generateProductSalesSummaryPDF() {
    showLoadingStatus("Fetching data for Product Sales Summary...");

    try {
        const response = await fetch(`${API_BASE_URL}/api/invoices`);
        if (!response.ok) await handleFetchError(response, "Failed to fetch invoices for summary.");
        const invoices = await response.json();

        if (!invoices || invoices.length === 0) {
            alert("No invoices found to generate a summary.");
            hideLoadingStatus("No data for summary.", true);
            return;
        }

        hideLoadingStatus("Generating Product Sales Summary PDF...", false);

        const allSaleItems = [];
        invoices.forEach(invoice => {
            invoice.items.forEach(item => {
                allSaleItems.push({
                    date: invoice.date,
                    partyName: invoice.partyName,
                    productName: item.productName,
                    packing: item.packing,
                    qty: parseFloat(item.qty) || 0,
                    unitPrice: parseFloat(item.unitPrice) || 0,
                    totalAmount: (parseFloat(item.qty) || 0) * (parseFloat(item.unitPrice) || 0)
                });
            });
        });

        allSaleItems.sort((a, b) => {
            const dateComparison = new Date(a.date) - new Date(b.date);
            if (dateComparison !== 0) return dateComparison;
            const partyComparison = a.partyName.localeCompare(b.partyName);
            if (partyComparison !== 0) return partyComparison;
            return a.productName.localeCompare(b.productName);
        });

        const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
        let currentY = 48;
        let firstPageForSummary = true;
        const pdfTitle = "Product Sales Details";

        const summaryPageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1 || !firstPageForSummary);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, {
            pageNumber: 1,
            addHeaderOnEveryPage: true,
            addWatermarkOnEveryPage: true,
            showSignatures: false
        }, pdfTitle);

        firstPageForSummary = false;

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 15;

        const head = [['Sr.', 'Date', 'Party Name', 'Product', 'Packing', 'Qty', 'Unit Price', 'Amount']];
        const body = allSaleItems.map((item, index) => [
            index + 1,
            item.date,
            item.partyName,
            item.productName,
            item.packing,
            item.qty,
            formatNumberInIndianStyle(item.unitPrice), // Indian format
            formatNumberInIndianStyle(item.totalAmount) // Indian format
        ]);

        if (body.length > 0) {
            doc.autoTable({
                head,
                body,
                startY: currentY,
                ...getPdfTableStyles(PDF_SECONDARY_COLOR, 8, 9),
                columnStyles: {
                    0: { cellWidth: 10, halign: 'center' },
                    1: { cellWidth: 20, halign: 'center' },
                    2: { cellWidth: 45, halign: 'left' },
                    3: { cellWidth: 40, halign: 'left' },
                    4: { cellWidth: 18, halign: 'center' },
                    5: { cellWidth: 15, halign: 'center' },
                    6: { cellWidth: 22, halign: 'right' },
                    7: { cellWidth: 22, halign: 'right' }
                },
                didDrawPage: summaryPageHook
            });
        } else {
            doc.setFontSize(9.5);
            doc.setFont("helvetica", "italic");
            doc.text("No product sales data to display.", 12, currentY);
        }

        doc.save('Product_Sales_Details.pdf');
        hideLoadingStatus("Product Sales Details PDF generated.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}
        function convertToWords(num) {
            if (num === 0) return 'Zero';
            const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const number = parseFloat(num);
            if (isNaN(number)) return '';
            const rupees = Math.floor(number);
            function numToWords(n) {
                if (n < 20) return a[n];
                let digit = n % 10;
                if (n < 100) return b[Math.floor(n / 10)] + (digit ? ' ' + a[digit] : '');
                if (n < 1000) return a[Math.floor(n / 100)] + ' Hundred' + (n % 100 === 0 ? '' : ' and ' + numToWords(n % 100));
                if (n < 100000) return numToWords(Math.floor(n/1000)) + ' Thousand' + (n % 1000 === 0 ? '' : ' ' + numToWords(n % 1000));
                if (n < 10000000) return numToWords(Math.floor(n/100000)) + ' Lac' + (n % 100000 === 0 ? '' : ' ' + numToWords(n % 100000));
                return 'Number too large';
            }
            return numToWords(rupees);
        }

        async function deleteAllBackendData() {
            if (!confirm("DANGER: This will DELETE ALL data from the server, including all invoices, payments, and party information. This action cannot be undone. Are you absolutely sure you want to proceed?")) return;
            showLoadingStatus("Deleting all backend data...");
            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/delete-all-data`, {
                    method: 'POST'
                });
                if (!response.ok) await handleFetchError(response, "Failed to delete all backend data.");
                const result = await response.json();
                hideLoadingStatus(result.message || "All backend data has been deleted successfully.", false);
                await populatePartyLists();
                await fetchAndSetNextInvoiceNumber();
                await fetchStockData();
                resetInvoiceForm(true);
                ledgerDisplayArea.innerHTML = '<p>All backend data has been deleted. The application is now in a fresh state.</p>';
                paymentDisplayArea.innerHTML = '<p>All backend data has been deleted. The application is now in a fresh state.</p>';
                openingBalanceHistoryArea.innerHTML = '<p>All backend data has been deleted. The application is now in a fresh state.</p>'; // Clear history area
                currentLedgerDataForPDF = null;
                downloadLedgerPdfBtn.style.display = 'none';
            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }

        function updateStockSerialNumbers() {
            const rows = stockEntryRowsContainer.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.querySelector('.stock-sr-no').textContent = index + 1;
            });
            stockSrNo = rows.length + 1;
        }

        function removeStockRow(button) {
            button.closest('tr').remove();
            updateStockSerialNumbers();
        }

        function addNewStockRow() {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="stock-sr-no">${stockSrNo}</span></td>
                <td><input type="text" class="stock-product-name" list="productListGlobal" placeholder="Product Name"></td>
                <td><input type="text" class="stock-batch-no" placeholder="e.g., B-12345"></td>
                <td><input type="date" class="stock-date"></td>
                <td><input type="number" class="stock-quantity" placeholder="0" min="0"></td>
                <td><button type="button" class="remove-row-btn" onclick="removeStockRow(this)">X</button></td>
            `;
            row.querySelector('.stock-date').value = new Date().toISOString().slice(0, 10);
            stockEntryRowsContainer.appendChild(row);
            stockSrNo++;
            updateStockSerialNumbers();
        }

        async function saveAllStock() {
            const stockItems = [];
            let formIsValid = true;
            stockEntryRowsContainer.querySelectorAll('tr').forEach(row => {
                const productName = row.querySelector('.stock-product-name').value.trim();
                const batchNo = row.querySelector('.stock-batch-no').value.trim();
                const date = row.querySelector('.stock-date').value;
                const quantity = parseInt(row.querySelector('.stock-quantity').value, 10);
                if (productName && (isNaN(quantity) || quantity <= 0 || !date)) {
                     alert(`Product "${productName}" ke liye sahi Quantity aur Date darj karen.`);
                     formIsValid = false;
                     return;
                }
                if (productName) {
                    stockItems.push({ productName, batchNo, date, quantity });
                }
            });

            if (!formIsValid || stockItems.length === 0) {
                alert("Barae meharbani save karne se pehle kam se kam ek valid stock item add karen.");
                return;
            }

            showLoadingStatus('Sab stock items save ho rahe hain...');
            try {
                const response = await fetch(`${API_BASE_URL}/api/stock/batch-add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: stockItems })
                });
                if (!response.ok) await handleFetchError(response, 'Stock items save karne me nakami.');
                const result = await response.json();
                hideLoadingStatus(result.message, false);
                await fetchStockData();
                stockEntryRowsContainer.innerHTML = '';
                stockSrNo = 1;
                addNewStockRow();
            } catch(error) {
                hideLoadingStatus(error, true);
            }
        }

        async function fetchStockData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/stock`);
                if(!response.ok) {
                    if(response.status === 404) {
                        stockTableBody.innerHTML = `<tr><td colspan="5" class="no-entries">Koi stock add nahi kiya gaya.</td></tr>`;
                        return;
                    }
                    await handleFetchError(response, "Stock data fetch karne me nakami.");
                }
                const stockData = await response.json();
                displayStockData(stockData);
            } catch(error) {
                hideLoadingStatus(error, true);
                stockTableBody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center;">Stock data load karne me nakami.</td></tr>`;
            }
        }

        function displayStockData(stockData) {
            stockTableBody.innerHTML = '';
            if (!stockData || stockData.length === 0) {
                stockTableBody.innerHTML = `<tr><td colspan="5" class="no-entries">Koi stock add nahi kiya gaya.</td></tr>`;
                return;
            }

            stockData.sort((a, b) => new Date(b.date) - new Date(a.date) || a.productName.localeCompare(b.productName))
            .forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${index + 1}</td>
                    <td>${item.productName}</td>
                    <td class="text-center">${item.batchNo || 'N/A'}</td>
                    <td class="text-center">${item.date || 'N/A'}</td>
                    <td class="text-center">${item.quantity}</td>
                `;
                stockTableBody.appendChild(row);
            });
        }

        async function downloadStockReportPDF() {
            showLoadingStatus("Stock report data fetch ho raha hai...");
            let stockDataForPdf = [];
            try {
                 const response = await fetch(`${API_BASE_URL}/api/stock`);
                 if(response.ok) {
                    stockDataForPdf = await response.json();
                 } else if (response.status !== 404) {
                     await handleFetchError(response, "Stock report ke liye data fetch karne me nakami.");
                     return;
                 }
            } catch(error) {
                hideLoadingStatus(error, true);
                return;
            }

            if (stockDataForPdf.length === 0) {
                alert("Report banane ke liye koi stock data nahi hai.");
                hideLoadingStatus("Report ke liye data nahi hai.", true);
                return;
            }

            hideLoadingStatus("Stock Report PDF ban rahi hai...", false);
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            let currentY = 48;
            const pdfTitle = "Inventory Stock Report";
            addPdfHeaderAndFooter(doc, { pageNumber: 1, addHeaderOnEveryPage: true, addWatermarkOnEveryPage: true, showSignatures: false }, pdfTitle);

            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...PDF_PRIMARY_COLOR);
            doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
            currentY += 15;

            const head = [['Sr.', 'Product Name', 'Batch No.', 'Date Added', 'Available Quantity']];
            const body = stockDataForPdf
                .sort((a, b) => new Date(b.date) - new Date(a.date) || a.productName.localeCompare(b.productName))
                .map((item, index) => [
                    index + 1,
                    item.productName,
                    item.batchNo || 'N/A',
                    item.date || 'N/A',
                    item.quantity
                ]);

            doc.autoTable({
                head: head,
                body: body,
                startY: currentY,
                ...getPdfTableStyles(PDF_SECONDARY_COLOR),
                columnStyles: {
                    0: { halign: 'center', cellWidth: 15 },
                    1: { halign: 'left' },
                    2: { halign: 'center', cellWidth: 40 },
                    3: { halign: 'center', cellWidth: 30 },
                    4: { halign: 'center', cellWidth: 40 }
                },
                didDrawPage: (data) => {
                    addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
                    currentY = 48;
                }
            });

            doc.save('Stock_Report.pdf');
            hideLoadingStatus("Stock Report PDF kamyabi se ban gayi.", false);
        }

        // Function to Display Party Payments for Deletion
        async function displayPartyPaymentsForDeletion() {
            const partyName = partySearchInputForPayments.value.trim();
            if (!partyName) {
                alert("Barae meharbani payments dekhne ke liye party ka naam darj karen.");
                paymentDisplayArea.innerHTML = '<p>Barae meharbani search karne ke liye party ka naam darj karen.</p>';
                return;
            }

            showLoadingStatus(`${partyName} ki payments fetch ho rahi hain...`);
            paymentDisplayArea.innerHTML = `<p><strong>${partyName}</strong> ki payments load ho rahi hain...</p>`;

            try {
                // Fetch payments for the specific party
                const response = await fetch(`${API_BASE_URL}/api/payments?partyName=${encodeURIComponent(partyName)}`);
                 if (!response.ok) {
                    if (response.status === 404) throw new Error(`Party "${partyName}" ke liye koi payments nahi mile.`);
                    await handleFetchError(response, `Payments fetch karne me nakami.`);
                }
                let payments = await response.json();

                if (!payments || payments.length === 0) {
                    paymentDisplayArea.innerHTML = `<p class="no-entries">Party "${partyName}" ke liye koi payments nahi mile.</p>`;
                    hideLoadingStatus(`Party "${partyName}" ke liye koi payments nahi mile.`, false);
                    return;
                }

                // Sort payments by date (ascending)
                payments.sort((a, b) => new Date(a.date) - new Date(b.date));

                let paymentsHTML = `<h4>Payments for: ${partyName}</h4>`;
                paymentsHTML += `<table class="payment-list-table">
                    <thead>
                        <tr>
                            <th class="text-center">Sr.</th>
                            <th class="text-center">Date</th>
                            <th>Party Name</th> <!-- Added Party Name column -->
                            <th>Remarks</th>
                            <th class="text-right">Amount (PKR)</th>
                            <th class="text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody>`;

                payments.forEach((payment, index) => {
                    paymentsHTML += `<tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${payment.date}</td>
                        <td>${payment.partyName}</td> <!-- Display Party Name -->
                        <td>${payment.remarks || ''}</td>
                        <td class="text-right">${parseFloat(payment.amount).toFixed(2)}</td>
                        <td class="text-center">
                            <button class="action-btn delete" onclick="deletePayment(${payment.paymentId}, '${partyName}')">Delete</button>
                        </td>
                    </tr>`;
                });

                paymentsHTML += `</tbody></table>`;
                paymentDisplayArea.innerHTML = paymentsHTML;

                hideLoadingStatus(`${partyName} ki payments dikha di gayi.`, false);

            } catch (error) {
                paymentDisplayArea.innerHTML = `<p style="color: red;">Error: ${error.message || 'Payments fetch nahi ho sake.'}</p>`;
                hideLoadingStatus(error, true);
            }
        }
// Add these functions to your existing JavaScript

// Initialize dates for new sections
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...

    // Set default dates for new sections
    const today = new Date().toISOString().slice(0, 10);
    const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0, 10);

    document.getElementById('biltyStartDate').value = firstDayOfMonth;
    document.getElementById('biltyEndDate').value = today;
    document.getElementById('excludeStartDate').value = firstDayOfMonth;
    document.getElementById('excludeEndDate').value = today;

    // Populate party list for exclude section
    populatePartyListForExclude();
});

// Function to populate party list for exclude section
async function populatePartyListForExclude() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/parties`);
        if (!response.ok) await handleFetchError(response, "Failed to fetch party list for exclude section.");
        const parties = await response.json();
        const datalist = document.getElementById('partyListForExclude');
        datalist.innerHTML = '';

        parties.sort((a, b) => a.name.localeCompare(b.name)).forEach(party => {
            const option = document.createElement('option');
            option.value = party.name;
            datalist.appendChild(option);
        });
    } catch (error) {
        console.error("Party list load error for exclude section:", error);
    }
}

// Function to generate Bilty Expense PDF
async function generateBiltyExpensePDF() {
    const startDate = document.getElementById('biltyStartDate').value;
    const endDate = document.getElementById('biltyEndDate').value;

    if (!startDate || !endDate) {
        alert("Please select start and end dates for Bilty Expense report.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date must be before end date.");
        return;
    }

    showLoadingStatus(`Fetching Bilty Expense records from ${startDate} to ${endDate}...`);

    try {
        // Fetch payments with "Bilty Expense" remarks
        const paymentsResponse = await fetch(`${API_BASE_URL}/api/payments?startDate=${startDate}&endDate=${endDate}`);
        if (!paymentsResponse.ok) await handleFetchError(paymentsResponse, "Failed to fetch payments for Bilty Expense report.");
        let payments = await paymentsResponse.json();

        // Filter payments with "Bilty Expense" in remarks
        const biltyExpensePayments = payments.filter(payment =>
            payment.remarks && payment.remarks.toLowerCase().includes('bilty expense')
        );

        if (biltyExpensePayments.length === 0) {
            alert(`No Bilty Expense records found in the specified date range (${startDate} to ${endDate}).`);
            hideLoadingStatus("No Bilty Expense records found.", true);
            return;
        }

        hideLoadingStatus(`Generating Bilty Expense PDF for ${startDate} to ${endDate}...`, false);

        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        let currentY = 48;
        const pdfTitle = `Bilty Expense Report (${startDate} to ${endDate})`;

        const pageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });
        currentY += 15;

        // Table for Bilty Expense records
        const head = [['Sr.', 'Date', 'Party Name', 'Remarks', 'Amount (PKR)']];
        const body = biltyExpensePayments.map((payment, index) => [
            index + 1,
            payment.date,
            payment.partyName,
            payment.remarks,
            formatNumberInIndianStyle(payment.amount)
        ]);

        doc.autoTable({
            head,
            body,
            startY: currentY,
            ...getPdfTableStyles(PDF_PRIMARY_COLOR),
            columnStyles: {
                0: { cellWidth: 12, halign: 'center' },
                1: { cellWidth: 25, halign: 'center' },
                2: { cellWidth: 50, halign: 'left' },
                3: { cellWidth: 60, halign: 'left' },
                4: { cellWidth: 30, halign: 'right' }
            },
            didDrawPage: pageHook
        });

        currentY = doc.autoTable.previous.finalY + 15;

        // Calculate totals
        const totalAmount = biltyExpensePayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
        const onePointFivePercent = totalAmount * 0.015;

        // Display totals
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);

        const totalsX = doc.internal.pageSize.getWidth() - 12 - 60;
        const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;

        doc.text("Total Bilty Expense:", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(totalAmount), amountsX, currentY, { align: 'right' });

        currentY += 8;

        doc.text("1.5% of Total:", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(onePointFivePercent), amountsX, currentY, { align: 'right' });

        // Add summary
        currentY += 15;
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Total Records: ${biltyExpensePayments.length}`, 12, currentY);
        currentY += 5;
        doc.text(`Period: ${startDate} to ${endDate}`, 12, currentY);

        doc.save(`Bilty_Expense_Report_${startDate}_to_${endDate}.pdf`);
        hideLoadingStatus("Bilty Expense PDF generated successfully.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}
// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    populatePartyExcludeDropdown();
    setupPartySelectionListener();
});

// Populate the party exclude dropdown
async function populatePartyExcludeDropdown() {
    try {
        showLoadingStatus('Loading parties...');
        const response = await fetch(`${API_BASE_URL}/api/parties`);
        if (!response.ok) throw new Error('Failed to fetch parties');
        const parties = await response.json();

        const dropdown = document.getElementById('excludePartyName');
        // Clear existing options except the first one
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }

        // Sort parties alphabetically for better UX
        parties.sort((a, b) => a.name.localeCompare(b.name));

        // Add parties to dropdown
        parties.forEach(party => {
            const option = document.createElement('option');
            option.value = party.name;
            option.textContent = party.name;
            dropdown.appendChild(option);
        });

        hideLoadingStatus('Parties loaded successfully.', false);
    } catch (error) {
        console.error('Error populating party exclude dropdown:', error);
        hideLoadingStatus('Failed to load parties.', true);
    }
}

// Setup listener for selection changes
function setupPartySelectionListener() {
    const selectElement = document.getElementById('excludePartyName');
    const summaryDiv = document.getElementById('selectedPartiesSummary');
    const listSpan = document.getElementById('selectedPartiesList');
    const countSpan = document.getElementById('selectedPartiesCount');

    selectElement.addEventListener('change', function() {
        const selectedParties = Array.from(this.selectedOptions)
            .map(opt => opt.value)
            .filter(value => value !== "");

        if (selectedParties.length > 0) {
            // Show first 3 parties in summary, show count for rest
            let displayText;
            if (selectedParties.length <= 3) {
                displayText = selectedParties.join(", ");
            } else {
                displayText = selectedParties.slice(0, 3).join(", ") + `, +${selectedParties.length - 3} more`;
            }

            listSpan.textContent = displayText;
            countSpan.textContent = `(${selectedParties.length} parties selected)`;
            summaryDiv.style.display = 'block';
        } else {
            summaryDiv.style.display = 'none';
        }
    });
}

// Main function to generate PDF
async function generatePartyExcludePDF() {
    const selectElement = document.getElementById('excludePartyName');
    const partiesToExclude = Array.from(selectElement.selectedOptions)
        .map(opt => opt.value.trim().toLowerCase())
        .filter(party => party !== ""); // Remove empty values

    const startDate = document.getElementById('excludeStartDate').value;
    const endDate = document.getElementById('excludeEndDate').value;

    // Validation
    if (partiesToExclude.length === 0) {
        alert("Please select at least one party to exclude.");
        return;
    }

    if (!startDate || !endDate) {
        alert("Please select start and end dates for Party Exclude report.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date must be before end date.");
        return;
    }

    showLoadingStatus(`Generating report excluding ${partiesToExclude.length} parties from ${startDate} to ${endDate}...`);

    try {
        // Fetch payments for the date range
        const paymentsResponse = await fetch(`${API_BASE_URL}/api/payments?startDate=${startDate}&endDate=${endDate}`);
        if (!paymentsResponse.ok) await handleFetchError(paymentsResponse, "Failed to fetch payments for Party Exclude report.");
        let payments = await paymentsResponse.json();

        // Filter payments: exclude selected parties and exclude payments with "Bilty Expense" remarks
        const filteredPayments = payments.filter(payment =>
            !partiesToExclude.includes(payment.partyName.toLowerCase()) &&
            (!payment.remarks || !payment.remarks.toLowerCase().includes('bilty expense'))
        );

        if (filteredPayments.length === 0) {
            alert(`No records found after excluding ${partiesToExclude.length} parties in the specified date range.`);
            hideLoadingStatus("No records found after filtering.", true);
            return;
        }

        hideLoadingStatus(`Generating PDF for ${filteredPayments.length} records...`, false);

        // Generate PDF
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        let currentY = 48;

        // Create title with party information
        let pdfTitle;
        if (partiesToExclude.length === 1) {
            pdfTitle = `Party Exclude Report (Excluding: ${partiesToExclude[0]})`;
        } else if (partiesToExclude.length <= 3) {
            pdfTitle = `Party Exclude Report (Excluding: ${partiesToExclude.join(", ")})`;
        } else {
            pdfTitle = `Party Exclude Report (Excluding ${partiesToExclude.length} Parties)`;
        }

        // Page hook for header and footer on each page
        const pageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        // First page header
        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        // Report title
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });

        currentY += 8;

        // Date range
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100, 100, 100);
        doc.text(`Period: ${formatDisplayDate(startDate)} to ${formatDisplayDate(endDate)}`, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });

        currentY += 12;

        // Summary information
        doc.setFontSize(9);
        doc.setTextColor(80, 80, 80);
        doc.text(`Total parties excluded: ${partiesToExclude.length}`, 14, currentY);
        doc.text(`Records after filtering: ${filteredPayments.length}`, doc.internal.pageSize.getWidth() - 14, currentY, { align: 'right' });

        currentY += 8;

        // Table for filtered records
        const head = [['Sr.', 'Date', 'Party Name', 'Remarks', 'Amount (PKR)']];
        const body = filteredPayments.map((payment, index) => [
            (index + 1).toString(),
            formatDisplayDate(payment.date),
            payment.partyName,
            payment.remarks || '-',
            formatNumberInIndianStyle(payment.amount)
        ]);

        doc.autoTable({
            head: head,
            body: body,
            startY: currentY,
            ...getPdfTableStyles(PDF_TERTIARY_COLOR),
            headStyles: {
                fillColor: [PDF_TERTIARY_COLOR[0], PDF_TERTIARY_COLOR[1], PDF_TERTIARY_COLOR[2]],
                textColor: 255,
                fontStyle: 'bold'
            },
            columnStyles: {
                0: { cellWidth: 15, halign: 'center' },
                1: { cellWidth: 25, halign: 'center' },
                2: { cellWidth: 45, halign: 'left' },
                3: { cellWidth: 55, halign: 'left' },
                4: { cellWidth: 35, halign: 'right' }
            },
            styles: {
                fontSize: 9,
                cellPadding: 3
            },
            didDrawPage: pageHook
        });

        currentY = doc.autoTable.previous.finalY + 15;

        // Calculate totals
        const totalAmount = filteredPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
        const onePointFivePercent = totalAmount * 0.015;

        // Display totals
        doc.setFontSize(11);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);

        const totalsX = doc.internal.pageSize.getWidth() - 20 - 60;
        const amountsX = doc.internal.pageSize.getWidth() - 20;

        doc.text("Total Amount:", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(totalAmount), amountsX, currentY, { align: 'right' });

        currentY += 8;

        doc.text("1.5% of Total:", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(onePointFivePercent.toFixed(2)), amountsX, currentY, { align: 'right' });

        // Add detailed summary section
        currentY += 20;

        // Only add excluded parties list if there's enough space
        if (currentY < 220) {
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
            doc.text("EXCLUSION SUMMARY", 14, currentY);

            currentY += 8;
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(80, 80, 80);

            doc.text(`• Parties Excluded: ${partiesToExclude.length}`, 20, currentY);
            currentY += 5;
            doc.text(`• Records Filtered Out: ${payments.length - filteredPayments.length}`, 20, currentY);
            currentY += 5;
            doc.text(`• Final Records Included: ${filteredPayments.length}`, 20, currentY);
            currentY += 5;
            doc.text(`• Also Excluded: Records with "Bilty Expense" remarks`, 20, currentY);

            // Add excluded parties list if space permits
            if (currentY < 250 && partiesToExclude.length > 0) {
                currentY += 10;
                doc.setFont("helvetica", "bold");
                doc.text("Excluded Parties List:", 14, currentY);
                currentY += 6;
                doc.setFont("helvetica", "normal");

                // Display parties in multiple columns if many
                if (partiesToExclude.length <= 8) {
                    const partiesText = partiesToExclude.map(party => `• ${party}`).join('\n');
                    const splitParties = doc.splitTextToSize(partiesText, 180);
                    doc.text(splitParties, 20, currentY);
                } else {
                    // For many parties, show in two columns
                    const midPoint = Math.ceil(partiesToExclude.length / 2);
                    const leftColumn = partiesToExclude.slice(0, midPoint);
                    const rightColumn = partiesToExclude.slice(midPoint);

                    const leftText = leftColumn.map(party => `• ${party}`).join('\n');
                    const rightText = rightColumn.map(party => `• ${party}`).join('\n');

                    doc.text(leftText, 20, currentY);
                    doc.text(rightText, 110, currentY);
                }
            }
        }

        // Save the PDF
        const filename = `Party_Exclude_Report_${startDate}_to_${endDate}.pdf`;
        doc.save(filename);

        hideLoadingStatus(`PDF generated successfully! Excluded ${partiesToExclude.length} parties, showing ${filteredPayments.length} records.`, false);

    } catch (error) {
        console.error('Error generating Party Exclude PDF:', error);
        hideLoadingStatus(`Error: ${error.message}`, true);
    }
}

// Helper function to format dates for display
function formatDisplayDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
}

// Helper function for error handling (you might already have this)
async function handleFetchError(response, defaultMessage) {
    let errorMessage = defaultMessage;
    try {
        const errorData = await response.json();
        if (errorData.message) {
            errorMessage = errorData.message;
        }
    } catch (e) {
        // If we can't parse JSON, use default message
    }
    throw new Error(errorMessage);
}

        // Function to Delete a Specific Payment
        async function deletePayment(paymentId, partyName) {
            if (!confirm(`Kya aap waqai yeh payment (ID: ${paymentId}) delete karna chahte hain? Yeh action reverse nahi kiya ja sakta.`)) {
                return;
            }

            showLoadingStatus(`Payment ID ${paymentId} delete ho rahi hai...`);
            try {
                // Send DELETE request to the backend
                const response = await fetch(`${API_BASE_URL}/api/payments/${paymentId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    await handleFetchError(response, `Payment ID ${paymentId} delete karne me nakami.`);
                }

                const result = await response.json();
                hideLoadingStatus(result.message || `Payment ID ${paymentId} kamyabi se delete ho gayi.`, false);

                // Refresh the payments list for the party
                await displayPartyPaymentsForDeletion();

                // Optionally refresh ledger if the party's ledger was displayed
                if (partySearchInput.value === partyName && ledgerDisplayArea.innerHTML.includes(partyName)) {
                     await displayPartyLedger();
                }
                 // Also refresh the party list as a party might be removed if this was their last transaction
                await populatePartyLists();


            } catch (error) {
                hideLoadingStatus(error, true);
            }
        }
// Function to generate Payments Without Bilty Expense PDF
async function generateNoBiltyExpensePDF() {
    const startDate = document.getElementById('noBiltyStartDate').value;
    const endDate = document.getElementById('noBiltyEndDate').value;

    if (!startDate || !endDate) {
        alert("Please select start and end dates for Payments Without Bilty Expense report.");
        return;
    }

    if (new Date(startDate) > new Date(endDate)) {
        alert("Start date must be before end date.");
        return;
    }

    showLoadingStatus(`Fetching payments without Bilty Expense from ${startDate} to ${endDate}...`);

    try {
        // Fetch payments for the date range
        const paymentsResponse = await fetch(`${API_BASE_URL}/api/payments?startDate=${startDate}&endDate=${endDate}`);
        if (!paymentsResponse.ok) await handleFetchError(paymentsResponse, "Failed to fetch payments for No Bilty Expense report.");
        let payments = await paymentsResponse.json();

        // Filter payments: exclude payments with "Bilty Expense" remarks
        const filteredPayments = payments.filter(payment =>
            !payment.remarks || !payment.remarks.toLowerCase().includes('bilty expense')
        );

        if (filteredPayments.length === 0) {
            alert(`No payments without Bilty Expense found in the specified date range.`);
            hideLoadingStatus("No payments without Bilty Expense found.", true);
            return;
        }

        hideLoadingStatus(`Generating Payments Without Bilty Expense PDF...`, false);

        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        let currentY = 48;
        const pdfTitle = `Payments Without Bilty Expense`;

        const pageHook = (data) => {
            addPdfHeaderAndFooter(doc, data, pdfTitle, data.pageNumber > 1);
            currentY = 48;
        };

        addPdfHeaderAndFooter(doc, { pageNumber: 1 }, pdfTitle);

        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_PRIMARY_COLOR[0], PDF_PRIMARY_COLOR[1], PDF_PRIMARY_COLOR[2]);
        doc.text(pdfTitle, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });

        currentY += 8;
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Period: ${startDate} to ${endDate}`, doc.internal.pageSize.getWidth() / 2, currentY, { align: 'center' });

        currentY += 12;

        // Table for filtered records
        const head = [['Sr.', 'Date', 'Party Name', 'Remarks', 'Amount (PKR)']];
        const body = filteredPayments.map((payment, index) => [
            index + 1,
            payment.date,
            payment.partyName,
            payment.remarks || '',
            formatNumberInIndianStyle(payment.amount)
        ]);

        doc.autoTable({
            head,
            body,
            startY: currentY,
            ...getPdfTableStyles(PDF_SECONDARY_COLOR),
            columnStyles: {
                0: { cellWidth: 12, halign: 'center' },
                1: { cellWidth: 25, halign: 'center' },
                2: { cellWidth: 50, halign: 'left' },
                3: { cellWidth: 60, halign: 'left' },
                4: { cellWidth: 30, halign: 'right' }
            },
            didDrawPage: pageHook
        });

        currentY = doc.autoTable.previous.finalY + 15;

        // Calculate totals
        const totalAmount = filteredPayments.reduce((sum, payment) => sum + parseFloat(payment.amount), 0);
        const onePointFivePercent = totalAmount * 0.015;

        // Display totals
        doc.setFontSize(12);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(PDF_TEXT_COLOR[0], PDF_TEXT_COLOR[1], PDF_TEXT_COLOR[2]);

        const totalsX = doc.internal.pageSize.getWidth() - 12 - 60;
        const amountsX = doc.internal.pageSize.getWidth() - 12 - 15;

        doc.text("Total Amount (No Bilty):", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(totalAmount), amountsX, currentY, { align: 'right' });

        currentY += 8;

        doc.text("1.5% of Total:", totalsX, currentY, { align: 'right' });
        doc.text(formatNumberInIndianStyle(onePointFivePercent), amountsX, currentY, { align: 'right' });

        // Add summary
        currentY += 15;
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text(`Total Records: ${filteredPayments.length}`, 12, currentY);
        currentY += 5;
        doc.text(`Filter: Excluded all payments with "Bilty Expense" in remarks`, 12, currentY);
        currentY += 5;
        doc.text(`Original Payments: ${payments.length}`, 12, currentY);
        currentY += 5;
        doc.text(`Bilty Expense Payments Excluded: ${payments.length - filteredPayments.length}`, 12, currentY);

        doc.save(`Payments_Without_Bilty_${startDate}_to_${endDate}.pdf`);
        hideLoadingStatus("Payments Without Bilty Expense PDF generated successfully.", false);

    } catch (error) {
        hideLoadingStatus(error, true);
    }
}

// Also add this to your DOMContentLoaded function to set default dates:
document.addEventListener('DOMContentLoaded', function() {
    // ... existing code ...

    // Set default dates for new section
    const today = new Date().toISOString().slice(0, 10);
    const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0, 10);

    document.getElementById('noBiltyStartDate').value = firstDayOfMonth;
    document.getElementById('noBiltyEndDate').value = today;
});
        // Function to display Opening Balance History
        async function displayOpeningBalanceHistory() {
             const partyName = partySearchInputForHistory.value.trim();
            if (!partyName) {
                alert("Barae meharbani history dekhne ke liye party ka naam darj karen.");
                openingBalanceHistoryArea.innerHTML = '<p>Barae meharbani search karne ke liye party ka naam darj karen.</p>';
                return;
            }

            showLoadingStatus(`${partyName} ki opening balance history fetch ho rahi hai...`);
            openingBalanceHistoryArea.innerHTML = `<p><strong>${partyName}</strong> ki opening balance history load ho rahi hai...</p>`;

            try {
                const response = await fetch(`${API_BASE_URL}/api/parties/${encodeURIComponent(partyName)}/opening-balance-history`);
                 if (!response.ok) {
                    if (response.status === 404) throw new Error(`Party "${partyName}" ke liye koi opening balance history nahi mili.`);
                    await handleFetchError(response, `Opening balance history fetch karne me nakami.`);
                }
                let history = await response.json();

                if (!history || history.length === 0) {
                    openingBalanceHistoryArea.innerHTML = `<p class="no-entries">Party "${partyName}" ke liye koi opening balance history nahi mili.</p>`;
                    hideLoadingStatus(`Party "${partyName}" ke liye koi opening balance history nahi mili.`, false);
                    return;
                }

                let historyHTML = `<h4>Opening Balance History for: ${partyName}</h4>`;
                historyHTML += `<table class="opening-balance-history-table">
                    <thead>
                        <tr>
                            <th class="text-center">Sr.</th>
                            <th class="text-center">Date</th>
                            <th class="text-right">Old Balance</th>
                            <th class="text-right">New Balance</th>
                            <th>Reason</th>
                            <th class="text-center">Recorded At</th>
                        </tr>
                    </thead>
                    <tbody>`;

                history.forEach((record, index) => {
                    historyHTML += `<tr>
                        <td class="text-center">${index + 1}</td>
                        <td class="text-center">${record.adjustment_date}</td>
                        <td class="text-right">${parseFloat(record.old_balance).toFixed(2)}</td>
                        <td class="text-right">${parseFloat(record.new_balance).toFixed(2)}</td>
                        <td>${record.reason || ''}</td>
                        <td class="text-center">${record.created_at}</td>
                    </tr>`;
                });

                historyHTML += `</tbody></table>`;
                openingBalanceHistoryArea.innerHTML = historyHTML;

                hideLoadingStatus(`${partyName} ki opening balance history dikha di gayi.`, false);

            } catch (error) {
                openingBalanceHistoryArea.innerHTML = `<p style="color: red;">Error: ${error.message || 'Opening balance history fetch nahi ho saki.'}</p>`;
                hideLoadingStatus(error, true);
            }
        }
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>

